---
title: "ETC5521 Assignment 1"
subtitle: "Your title"
team: Possum
author:
  - Brenwin Ang
  - Joyce Lee
date: "`r Sys.Date()`"
output: 
  html_document
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE)
library(tidyverse)
library(knitr)
library(kableExtra)
library(gridExtra)
library(sf)
library(data.table)
library(ggthemes)
```


```{r getting-data}
# Get the Data
volcano <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/volcano.csv')
eruptions <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/eruptions.csv')
events <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/events.csv')
tree_rings <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/tree_rings.csv')
sulfur <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/sulfur.csv')

# tectonic plates coordinates
rof <- read_csv("all.csv")
```


# Introduction and motivation

Volcanoes are nature's explosive land forms and yet one of the most beautiful. We chanced upon data set released by `TidyTuesday` which is probably one of if not the most comprehensive data set to learn more about volcanoes. 

Volcanoes date back to hundreds and thousands of years ago. This data exploration takes a closer look at the more recent active volcanoes around. 

We start with a brief introduction into the world of volcanoes, then visit the interaction between volcano & humans and finally looking into the characteristics of volcano.

 
# Data description

The data source is from [The Smithsonian Institution](https://volcano.si.edu/). The data is available, and cleaned, downloadable from [tidytuesday github](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md). Cleaning script is also supplied.


Data provided contains 5 linked data sets, each with looking at a particular aspect of volcano:  

- `volcano`: Provides information on 958 volcanoes such as
  - its metadata: volcano name, type, country location, evidence category, longitude and latitude
  - technical details: major & minor rocks, tectonic settings
  - distance from nearest population (km)
  
- `eruptions`: Details eruptions occured since Holecene (dubbed time since the end of "ice age") period (11,345 years ago) to present. Details include  
  - VEI (volcano explosivity index), date of eruption, eruption category/type, evidence method

- `events`: any event that occur at the volcanoes documented.
  - such as explosion, dome/cone formation, fatalities, evacuation, loud audible noises among others.

- `tree_ring`: Tree rings were used as a climate proxy. In study of effects on volcanoes on climate change, researchers matched effects of eruptions to tree ring records. 

- `sulfur`
  - Provide information on sulphur detected from 500.CE to 706.CE

# Analysis and findings

## World Of Active Volcanoes

```{r volcano, include = FALSE}
#types of volcanoes
volcano %>% 
  count(primary_volcano_type) 

# categorize volcanoes into 4 main types
volcano_types <- volcano %>% 
  mutate(primary_volcano_type = case_when(
    str_detect(primary_volcano_type, "Stratovolcano") ~ "Stratovolcano",
    str_detect(primary_volcano_type, "Shield") ~ "Shield",
    str_detect(primary_volcano_type, "Caldera") ~ "Caldera",
    TRUE ~ "Other"
  ))

volcano_types %>% 
  count(primary_volcano_type)

unique(volcano_types$primary_volcano_type)
```

### World Map of Active Volcanoes erupt

```{r volcano-erupted, include = FALSE}
# join only volcanoes that erupted
volcano_erupted <-inner_join(volcano_types, eruptions) %>%
  # select relevant variables
  select(volcano_name, vei, start_year, end_year, last_eruption_year, primary_volcano_type, country, latitude, longitude, elevation, evidence_category, population_within_5_km, population_within_10_km, population_within_30_km, population_within_100_km) %>% 
# concatenate country & volcano name
  mutate(volcano = str_c(volcano_name, country, sep = " -"), .keep = "all") 

# summarize volcano erupted; keeping all columns
volcano_erupted <- volcano_erupted %>% 
  group_by(volcano) %>%
  # find count (i.e. no. of times volcano erupted)
  mutate(n = n()) %>%  
  distinct(volcano, 
           .keep_all = TRUE) %>% 
  ungroup()
```

```{r volcano-types-eruptions, fig.align="center"}
# No. of eruptions by Volcano tyepes
volcano_erupted %>% 
  group_by(primary_volcano_type) %>% 
  summarize(no_of_eruptions = sum(n)) %>% 
  arrange(-no_of_eruptions) %>% 
  ggplot() +
  geom_col(aes(x = reorder(primary_volcano_type, -no_of_eruptions),
               y = no_of_eruptions),
           width = 0.1,
           space = 0.1,
           fill = "orange") +
  labs(x = "Primary Volcano Types",
       y = "Number of eruptions") +
  ggtitle("Number of eruptions for Primary Volcano Types") +
  theme_minimal() +
  theme(axis.text = element_text(colour = "white"),
        axis.title = element_text(colour = "white")) +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) 
  
```

There are 3 main types of Active Volcanoes (erupted before) namely Stratovolcano, Caldera and Shield. We decided to label the others as `others`. Stratovolcanoes are by far the most active volcano. 

```{r plates, include = FALSE}
plate <- unique(rof$plate) %>% 
  tibble(plate = .)

# convert to sf object & split into 2 polygons (to prevent across dateline)
plates <- purrr::map(.x = plate$plate,
    .f = function(x){st_polygon(x = list(as.matrix(rof %>% filter(plate == x) %>%  
                                      select(lon, lat)))) %>% sf::st_wrap_dateline()
    }) 

# convert polygons back to dataframe
plates2 <- lapply(seq_along(plates), 
                 function(i) as.data.frame(plates[[i]][[1]]) %>% 
                   mutate(group = i)) %>%
  data.table::rbindlist() %>% 
  rename(lon = V1, lat = V2)
```


```{r world-map, fig.align = "center", fig.width=14, fig.height=8}
world <- map_data("world")

# add continent coordinates
continent_coord <- tibble(id = c("Africa", "Asia", "Europe", "North America", "Oceania", "South America"),
                          long = c(15, 80, 20, -100, 150, -60),
                          lat = c(15, 35, 50, 40, -25, -15),
                          stringsAsFactors = F)

# add ring of fire coordinates
ring_of_fire <- tibble(id = c("Pacific Ocean", "Pacific Ocean"), 
                    long = c(180, -180),
                    lat = c(35, 35))

# ----- plot world map
world %>% 
  ggplot() +
  geom_map(map = world,
           aes(x = long, y = lat,
               map_id = region),
           fill = "dark grey") +
  geom_point(data = volcano_erupted,
             aes(x = longitude, y = latitude,
                 shape = primary_volcano_type),
             colour = "orange",
             fill = "red",
             size = 5) +
  scale_shape_manual(values = c(22, 23, 24, 20)) +
  theme(legend.position = "bottom") +
  geom_polygon(data = plates2,
               aes(x = lon,
                   y = lat,
                   group = group),
               fill = NA,
               colour = "dark green",
               size = 2) +
  labs(subtitle = "World map of volcanoes with documented eruptions") +
  # add continent text
  geom_text(data = continent_coord,
            aes(x = long, 
                y = lat,
                label = id),
            colour = "blue",
            size = 5) +
  geom_label(data = ring_of_fire,
            aes(x = long, 
                y = lat,
                label = id),
            colour = "blue") +
  # remove legends
  guides(colour = FALSE,
         size = FALSE,
         alpha = FALSE) +
  ggtitle("Active Volcanoes, Tectonic Plates and The Ring of Fire") +
  theme_map() +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) 
  

  
```

We then plotted the world map of Active Volcanoes with tectonic plate boundaries overlaid. 

We found that most of the volcanoes lie along the Pacific Ocean tracing the boundaries of tectonic plates. We later found that was dubbed the [Ring of Fire(or Circum-Pacific Belt)](https://www.nationalgeographic.org/encyclopedia/ring-fire/) . This path is approximately 40,000km long and holds 75% of the World's Volcanoes are situated and 90% of active ones! The abundance of volcanoes are explained by significant tectonic plates in the area since volcanoes are formed by either converging or diverging tectonic plate boundaries, creating cracks in earth. 

To achieve the map, we could not just plot the tectonic boundaries as the polygons stretch across the world map (looking like they are at opposite ends of the world when in fact they are side by side since the globe is round while ggplot is 2D). So, we split the tectonic plates at the prime meridian (x-intercept where long = 0) - was assisted by a helpful member at [StackOverflow](https://stackoverflow.com/questions/63591697/how-to-split-tectonic-plate-boundary-polygon-in-a-way-to-prevent-line-across-the/63593236?noredirect=1#comment112479435_63593236)

```{r ring-of-fire, fig.align="center", fig.height=8, fig.width=14}
# ---- fix longitude; recenter coordinates to center around ring of fire
volcano_erupted <- volcano_erupted %>% 
  mutate(long_fixed = ifelse(longitude < 0, yes = longitude + 360, no = longitude)) %>% 
  filter(long_fixed > 60 & long_fixed < 320,
         latitude > -50) 
  
# --- plot world map with Pacific Ocean in the middle 
world2 <- map_data("world2") %>% 
  # filter to coordinates within ring of fire
  filter(long > 60 & long < 320)

# --- plot prominent countries coordinates
countries_rof_coord <- tibble(id = c("Australia", "New Zealand", "South America", "North America", "Japan"), long = c(130, 174, 310, 265, 140), lat = c(-25, -40, -20, 50, 33))

ggplot() +
  # plot world map
  geom_polygon(data = world2,
               aes(x = long, y = lat, group = group),
               fill = "dark grey") +
  # plot active volcanoes points
  geom_point(data = volcano_erupted,
               aes(x = long_fixed, y = latitude,
                   size = n),
             colour = "red") +
  scale_size(range = c(2,5), 
             breaks = c(10, 50, 100, 180),
             name = "Number of eruptions") +
  geom_text(data = countries_rof_coord,
            aes(x = long, y = lat, label = id),
            colour = "blue") +
  ggtitle("The Ring of Fire") +
  labs(subtitle = "Pacific Rim Volcanoes with documented eruptions") +
  theme_map() +
  annotate("text", x = 200, y = 30,
           label = "Ring of Fire",
           colour = "pink",
           family = "Palatino",
           size = 9) +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20"),
        legend.box.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange"))
```

This map zoomed into the Ring Of Fire showing volcanoes running along the boundaries. As we can see, the volcanoes here are has more eruptions relatively speaking. 

## The interaction between volcanoes and humans - How worried should you be about volcanoes?

### Population around volcanoes' vicinity

```{r plotpop-exploration, include = FALSE}
volcano_erupted %>% 
  summarize(mean_5km = summary(population_within_5_km),
            mean_10km = summary(population_within_10_km),
            mean_30km = summary(population_within_30_km),
            mean_100km = summary(population_within_100_km))

volcano_population <- volcano_erupted %>% 
  mutate(no_of_people_5km = case_when(population_within_5_km <= 100 ~ "<= 100", 
                                  population_within_5_km >= 101 & population_within_5_km <= 1000 ~ "101-1,000",
                                  population_within_5_km > 1000 & population_within_5_km <= 10000 ~ "1,001-10,000",
                                  population_within_5_km > 10000 & population_within_5_km <= 100000 ~ "10,000-100,000",
                                  population_within_5_km > 100000 & population_within_5_km <= 1000000 ~ "100,001-1,000,000",
                                  population_within_5_km > 1000000 ~ "> 1,000,000")) 

volcano_population <- volcano_population %>% 
  mutate(no_of_people_10km = case_when(population_within_10_km <= 100 ~ "<= 100", 
                                  population_within_10_km >= 101 & population_within_10_km <= 1000 ~ "101-1,000",
                                  population_within_10_km > 1000 & population_within_10_km <= 10000 ~ "1,001-10,000",
                                  population_within_10_km > 10000 & population_within_10_km <= 100000 ~ "10,000-100,000",
                                  population_within_10_km > 100000 & population_within_10_km <= 1000000 ~ "100,001-1,000,000",
                                  population_within_10_km > 1000000 ~ "> 1,000,000")) 


volcano_population <- volcano_population %>% 
  mutate(no_of_people_30km = case_when(population_within_30_km <= 100 ~ "<= 100", 
                                  population_within_30_km >= 101 & population_within_30_km <= 1000 ~ "101-1,000",
                                  population_within_30_km > 1000 & population_within_30_km <= 10000 ~ "1,001-10,000",
                                  population_within_30_km > 10000 & population_within_30_km <= 100000 ~ "10,000-100,000",
                                  population_within_30_km > 100000 & population_within_30_km <= 1000000 ~ "100,001-1,000,000",
                                  population_within_30_km > 1000000 ~ "> 1,000,000")) 

volcano_population <- volcano_population %>% 
  mutate(no_of_people_100km = case_when(population_within_100_km <= 100 ~ "<= 100", 
                                  population_within_100_km >= 101 & population_within_100_km <= 1000 ~ "101-1,000",
                                  population_within_100_km > 1000 & population_within_100_km <= 10000 ~ "1,001-10,000",
                                  population_within_100_km > 10000 & population_within_100_km <= 100000 ~ "10,000-100,000",
                                  population_within_100_km > 100000 & population_within_100_km <= 1000000 ~ "100,001-1,000,000",
                                  population_within_100_km > 1000000 ~ "> 1,000,000")) 

volcano_population_long <- volcano_population %>% 
  pivot_longer(cols = no_of_people_5km:no_of_people_100km,
               names_to = "category",
               values_to = "no_of_people") %>% 
  mutate(no_of_people = factor(no_of_people, levels = c("<= 100", "101-1,000", "1,001-10,000", "10,000-100,000", "100,001-1,000,000", "> 1,000,000")))

volcano_population_long$category <- factor(volcano_population_long$category, levels = c("no_of_people_100km", "no_of_people_30km", "no_of_people_10km", "no_of_people_5km"))

pop_plot <- volcano_population_long %>% 
  group_by(category) %>% 
  ggplot() +
  geom_bar(aes(x = as.factor(no_of_people)),
           fill = "orange") +
  facet_wrap(~category, ncol = 1) +
  coord_flip() +
  ylab("categories (number of people)") +
  xlab("count") +
  theme_void() +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange")) +
  theme(axis.title.x = element_text(colour = "white"),
        axis.text.x = element_text(colour = "white"),
        axis.text.y = element_text(colour = "white",
                                   hjust = 1),
        axis.title = element_text(colour = "white"))

```



```{r triangles-fun, fig.align="center", fig.height=12, fig.width=18}
dt.triangle <- data.table(group = c(1,1,1,
                                    2,2,2,
                                    3,3,3,
                                    4,4,4,
                                    5,5,5,
                                    6,6,6,
                                    
                                    7,7,7,
                                    8,8,8,
                                    9,9,9,
                                    10,10,10,
                                    11,11,11,
                                    12,12,12,
                                    
                                    13,13,13,
                                    14,14,14,
                                    15,15,15,
                                    16,16,16,
                                    17,17,17,
                                    18,18,18,
                                    
                                    19,19,19,
                                    20,20,20,
                                    21,21,21,
                                    22,22,22,
                                    23,23,23,
                                    24,24,24),
                                    
                          polygon.x = c(0,2,1,
                                        3,5,4,
                                        6,8,7,
                                        9,11,10,
                                        12,14,13,
                                        15,17,16,
                                        
                                        0,2,1,
                                        3,5,4,
                                        6,8,7,
                                        9,11,10,
                                        12,14,13,
                                        15,17,16,
                                        
                                        0,2,1,
                                        3,5,4,
                                        6,8,7,
                                        9,11,10,
                                        12,14,13,
                                        15,17,16,
                                        
                                        0,2,1,
                                        3,5,4,
                                        6,8,7,
                                        9,11,10,
                                        12,14,13,
                                        15,17,16),
                          
                          polygon.y = c(0,0,22.6,
                                        0,0,13.3,
                                        0,0,11.3,
                                        0,0,4.5,
                                        0,0,0.7,
                                        
                                        32.6,32.6,32.6 + 16.2,
                                        32.6,32.6,32.6 + 9.9,
                                        32.6,32.6,32.6 + 12.2,
                                        32.6,32.6,32.6 + 11.6,
                                        32.6,32.6,32.6 + 3.2,
                                        32.6,32.6,32.6 + 0.7,
                                        
                                        58.8,58.8,58.8 + 9.2,
                                        58.8,58.8,58.8 + 6.2,
                                        58.8,58.8,58.8 + 10.9,
                                        58.8,58.8,58.8 + 9.5,
                                        58.8,58.8,58.8 + 12.4,
                                        58.8,58.8,58.8 + 5.6,
                                        
                                        81.2,81.2,81.2 + 3.7,
                                        81.2,81.2,81.2 + 2.6,
                                        81.2,81.2,81.2 + 5.9,
                                        81.2,81.2,81.2 + 6.7,
                                        81.2,81.2,81.2 + 13.7,
                                        81.2,81.2,81.2 + 21.2))
                                        
text <- tibble(id = c("Population within 5km", "Population within 10km", "Population within 30km", "Population within 100km"), 
               x = rep(9.5,4),
               y = c(22.6 + 2, 32.6+16.2+2, 58.8+12.4+2, 81.2+21.2+2))

no_of_people_comment1 <- tibble(id = rep("<=100", 4),
                               x = rep(1,4),
                               y = c(-2,30.6,56.8,79.2)) # -2

no_of_people_comment2 <- tibble(id = rep("101-1,000", 4),
                               x = rep(4,4),
                               y = c(-2,30.6,56.8,79.2))

no_of_people_comment3 <- tibble(id = rep("1,001-10,000", 4),
                               x = rep(7,4),
                               y = c(-2,30.6,56.8,79.2))

no_of_people_comment4 <- tibble(id = rep("10,000-100,000", 4),
                               x = rep(10,4),
                               y = c(-2,30.6,56.8,79.2))

no_of_people_comment5 <- tibble(id = rep("100,001-1,000,000", 4),
                               x = rep(13,4),
                               y = c(-2,30.6,56.8,79.2))

no_of_people_comment6 <- tibble(id = rep("> 1,000,000", 4),
                               x = rep(16,4),
                               y = c(-2,30.6,56.8,79.2))


no_of_volcanoes_text <- tibble(id = c("226 volcanoes", "162 volcanoes", "92 volcanoes", "37 volcanoes"),
                               x = rep(1,4),
                               y = c(-4,28.6,54.8,77.2))

no_of_volcanoes_text2 <- tibble(id = c("133 volcanoes", "99 volcanoes", "62 volcanoes", "26 volcanoes"),
                               x = rep(4,4),
                               y = c(-4,28.6,54.8,77.2))


no_of_volcanoes_text3 <- tibble(id = c("113 volcanoes", "122 volcanoes", "109 volcanoes", "59 volcanoes"),
                               x = rep(7,4),
                               y = c(-4,28.6,54.8,77.2))

no_of_volcanoes_text4 <- tibble(id = c("45 volcanoes", "116 volcanoes", "95 volcanoes", "67 volcanoes"),
                               x = rep(10,4),
                               y = c(-4,28.6,54.8,77.2))

no_of_volcanoes_text5 <- tibble(id = c("14 volcanoes", "32 volcanoes", "124 volcanoes", "137 volcanoes"),
                               x = rep(13,4),
                               y = c(-4,28.6,54.8,77.2))

no_of_volcanoes_text6 <- tibble(id = c("7 volcanoes", "7 volcanoes", "56 volcanoes", "212 volcanoes"),
                               x = rep(16,4),
                               y = c(-4,28.6,54.8,77.2))

triangle <- ggplot() +
  geom_polygon(data = dt.triangle,
               aes(x = polygon.x, y = polygon.y, group = group),
               fill = "orange") +
  geom_text(data = text,
            aes(x = x, y = y, label = id),
            size = 8,
            colour = "white") +
  ggtitle("Population within 5, 10, 30, 100km from Volcano") +
  theme_void() +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) +
  geom_text(data = no_of_people_comment1,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
   geom_text(data = no_of_people_comment2,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
  geom_text(data = no_of_people_comment3,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
   geom_text(data = no_of_people_comment4,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
  geom_text(data = no_of_people_comment5,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
  geom_text(data = no_of_people_comment6,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
 
  geom_text(data = no_of_volcanoes_text,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
  geom_text(data = no_of_volcanoes_text2,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
  geom_text(data = no_of_volcanoes_text3,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
  geom_text(data = no_of_volcanoes_text4,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
    geom_text(data = no_of_volcanoes_text5,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
  geom_text(data = no_of_volcanoes_text6,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") 

grid.arrange(triangle, pop_plot, ncol = 2,
             widths = c(0.7, 0.3))
   

```

Above, the height of the triangle/volcanoes corresponds to the number of volcanoes within one of the six population category that is within 5km, 10km, 30km and 100km from the volcano respectively. *give better explation*

There is no fixed safety risk zones(or distnace) as volcanoes are unpredictable. However, it is said around 1km for small/medium sized eruptions(VEI = 1-2) is relatively safe as long as volcanic projectiles do not fall in that area. Given this, most volcanoes are less than 5km from a population of people. Above figure was inspired by [Sil Aarts'](https://twitter.com/sil_aarts/status/1260156344319041537/photo/1) visualization.

### World map with number of eruptions in each country

```{r volcano-erupted-countries, fig.height=8, fig.width=14}
volcano_erupted %>% 
  arrange(-n) %>% 
  head(10) %>% 
  ggplot() +
  geom_col(aes(x = reorder(volcano, -n),
               y  = n),
           width = 0.1,
           space = 0.1,
           fill = "orange") +
  labs(x = "Volcano",
       y = "Number of eruptions") +
  ggtitle("Top 10 Most Active Volcanoes") +
  theme_minimal() +
  theme(axis.text = element_text(colour = "white",
                                 size = 12),
        axis.text.x = element_text(angle = 45),
        axis.title = element_text(colour = "white",
                                  size = 18)) +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) 
  
  
```


```{r volcano-countries, fig.height=8, fig.width=14}
# clean volcano$country to match world data set
volcano_country <- volcano_erupted %>% 
  mutate(country = case_when(
    country == "Armenia-Azerbaijan" ~ "Armenia",
    country == "Burma (Myanmar)" ~ "Burma",
    country %in% c("Chile-Argentina","Chile-Bolivia", "Chile-Peru") ~ "Chile",
    country == "China-North Korea" ~ "China",
    country == "Colombia-Ecuador" ~ "Colombia",
    country %in% c("DR Congo", "DR Congo-Rwanda") ~ "Democratic Republic of the Congo",
    country == "El Salvador-Guatemala" ~ "El Salvador",
    country == "Eritrea-Djibouti" ~ "Eritrea",
    country %in% c("Ethiopia-Djibouti", "Ethiopia-Kenya") ~ "Ethiopia",
    country == "Guatemala-El Salvador" ~ "Guatemala",
    country == "Japan - administered by Russia" ~ "Japan",
    country == "Mexico-Guatemala" ~ "Mexico",
    country == "North Korea-South Korea" ~ "North Korea",
    country == "Saint Kitts and Nevis" ~ "Saint Kitts",
    country == "Syria-Jordan-Saudi Arabia" ~ "Syria",
    country == "Saint Vincent and the Grenadines" ~ "Saint Vincent",
    country == "Uganda-Rwanda" ~ "Uganda",
    country == "United Kingdom" ~ "UK",
    country == "United States" ~ "USA",
    TRUE ~ country
  )) 

volcano_country_count <- volcano_country %>% 
  group_by(country) %>% 
  count() %>% 
  ungroup()

world <- map_data("world")

volcano_country_join <- left_join(world, volcano_country_count,
          by = c("region" = "country")) %>% 
  # replace n = NA to 0
  mutate(n = ifelse(is.na(n), 0, n))

# plot world map; fill number of volcanoes that erupt in each country 
volcano_country_join %>% 
  ggplot() +
  geom_map(map = volcano_country_join,
           aes(x = long, y = lat, map_id = region,
               fill = n)) +
  scale_fill_gradient(low = "dark grey",
                      high = "#ff8000",
                      name = "number of eruptions") +
  # plot dot points representing active volcanoes
  geom_point(data = volcano_erupted,
             aes(x = longitude, y = latitude,
                 size = population_within_5_km),
                 colour = "red") +
  scale_size(range = c(2,7),
            name = "population within 5km",
            breaks = c(100, 1000, 10000, 100000, 1000000, 40640105),
            labels = c("<=100", "101-1000", "1001,10,000", "10,000-100,000", "100,001-1000,000", ">100,000")) +
  ggtitle("World Map with countries experiencing most eruptions") +
   theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20"),
        legend.box.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20")) +
  theme(plot.title = element_text(size = 25, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) +
  annotate("label", x = -100, y = 40,
           label = "North America",
           colour = "blue",
           family = "Palatino",
           size = 4) +
  annotate("label", x = 140, y = 33,
           label = "Japan",
           colour = "blue",
           family = "Palatino",
           size = 4) +
  annotate("label", x = 105, y = -10,
           label = "Indonesia",
           colour = "blue",
           family = "Palatino",
           size = 4) +
  annotate("label", x = -80, y = -35,
           label = "Chile",
           colour = "blue",
           family = "Palatino",
           size = 4) +
  annotate("label", x = 130, y = 60,
           label = "Russia",
           colour = "blue",
           family = "Palatino",
           size = 4)
```

Above shows plot with fill depending on the number of eruptions in each country and larger dot sizes represent the number of population in the vicinity. 


### How likely will a volcano erupting in each VEI category after 1812?

VEI measures the explosiveness of volcanic eruptions. It is determined by the volume of materials thrown out(e.g. pyroclastic flow like smoke, ash etc.), eruption cloud height and qualitative observations. As qualitatlively described using terms ranging from "gentle" to "mega-colossal" [[Wikipedia](https://en.wikipedia.org/wiki/Volcanic_Explosivity_Index)]. For example, VEI of 0 given for non-explosive eruptions ($<10,000m^3$ of fragmental material produced by eruption called tephra). While VEI of 8 can eject $1\times10^12m^3$ of tephra.

Theoretically, VEI is ranges from 0 to infinity. VEI scaled is on a log scale. Therefore each interval (increase of 1 in VEI) indicate an eruption 10x more powerful. Looking back at the last 132 million years, there were only 40 eruptions documented with VEI-8 magnitude and 10 eruptions of VEI-7 in last 10,000 years.

We filtered the data set to after 1812 where the last observed VEI 7 was recorded at Mount Tambora. 

```{r eruptions-1812-wrangling}
# filter eruptions; to after 1812: eruption of Mount Tambora
eruptions_1812 <- eruptions %>% 
  filter(start_year >= 1812) 

# see lag; between last eruption to next
eruptions_1812 <- eruptions_1812 %>% 
  arrange(start_year, volcano_name) %>%  
  group_by(volcano_name) %>% 
  # find year between eruptions = year of eruption + (time between last and start of eruption)
  mutate(lag_year = start_year + (lag(start_year) - start_year))
```


```{r eruptions-1812-pdf}
library(ggridges)
eruptions_1812_pdf <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  group_by(volcano_name, vei) %>% 
  mutate(no_of_eruptions = n(),
         vei = factor(vei, levels = c(0, 1, 2,3 ,4, 5, 6, 7))) 

eruptions_1812_pdf <- eruptions_1812_pdf %>% 
  ggplot() +
  stat_density_ridges(aes(y = factor(vei, levels = c(0,1,2,3,4,5,6,7)),
                          x = no_of_eruptions,
                          fill = vei),
                      # colour median line & adjust size
                      quantile_lines = TRUE,
                      vline_color = "red",
                      vline_size = 1.5,
                      quantiles = 0.5,
                      # add jittered points
                      jittered_points = TRUE,
                      alpha = 0.7,
                      position = "raincloud") +
  scale_x_continuous(breaks = seq(from = 0, to = 70, by = 5 )) +
  ylab("VEI") +
  xlab("number of eruptions") +
  ggtitle("Probability density function of eruptions in each VEI category") +
  theme(plot.title = element_text(face = "bold",
                                  size = 15))
```

```{r eruptions-1812-nsum}
# numerical summary
eruptions_1812_nsum <- eruptions_1812 %>% 
  ungroup() %>% 
  group_by(vei) %>% 
  count() 

eruptions_1812_nsum <- eruptions_1812_nsum %>% 
  ungroup() %>% 
  filter(!is.na(vei)) %>% 
  mutate(total = sum(n),
         cumsum = cumsum(n)) %>% 
  mutate(percent = round(100*cumsum/total,2)) %>% 
  mutate(percent_change = round(percent - lag(percent),2)) %>% 
  select(vei, percent, percent_change) 

# concatenate < VEI
eruptions_1812_nsum$vei <- str_c("< VEI-", eruptions_1812_nsum$vei)

eruptions_1812_nsum <- eruptions_1812_nsum
```

```{r plot-nsum, fig.align="center", fig.width = 13}
# change table to tableGrob
t1 <- tableGrob(eruptions_1812_nsum, theme=ttheme_minimal(), rows=NULL)

grid.arrange(eruptions_1812_pdf, t1, ncol = 2,
             widths = c(80,20),
             padding = 2)
```

The density plots above shows that likelihood of a VEI 4 and above is very unlikely (less than 1%). In fact, almost 98% of all volcanoes have less than VEI-3. 


### How Frequent does volcanoes erupt?
```{r}
volcano_frequent0 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 0) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency)

volcano_frequent0$lag_year <- as.integer(volcano_frequent0$lag_year)

volcano_frequent0$volcano <- as.factor(str_c(volcano_frequent0$volcano_name, "-", volcano_frequent0$vei))

volcano_frequent1 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 1) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 

volcano_frequent1$lag_year <- as.integer(volcano_frequent1$lag_year)

volcano_frequent1$volcano <- as.factor(str_c(volcano_frequent1$volcano_name, "-", volcano_frequent1$vei))

volcano_frequent2 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 2) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 

volcano_frequent2$lag_year <- as.integer(volcano_frequent2$lag_year)

volcano_frequent2$volcano <- as.factor(str_c(volcano_frequent2$volcano_name, "-", volcano_frequent2$vei))

volcano_frequent3 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 3) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 

volcano_frequent3$lag_year <- as.integer(volcano_frequent3$lag_year)

volcano_frequent3$volcano <- as.factor(str_c(volcano_frequent3$volcano_name, "-", volcano_frequent3$vei))

volcano_frequent4 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 4) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 

volcano_frequent4$lag_year <- as.integer(volcano_frequent4$lag_year)

volcano_frequent4$volcano <- as.factor(str_c(volcano_frequent4$volcano_name, "-", volcano_frequent4$vei))
  
volcano_frequent5 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 5) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency)   

volcano_frequent5$lag_year <- as.integer(volcano_frequent5$lag_year)

volcano_frequent5$volcano <- as.factor(str_c(volcano_frequent5$volcano_name, "-", volcano_frequent5$vei))

volcano_frequent6 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 6) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) %>% 
  head(1)


volcano_frequent6$lag_year <- as.integer(volcano_frequent6$lag_year)

volcano_frequent6$volcano <- as.factor(str_c(volcano_frequent6$volcano_name, "-", volcano_frequent6$vei))

volcano_frequent7 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 7) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 
  
volcano_frequent7$lag_year <- as.integer(volcano_frequent7$lag_year)

volcano_frequent7$volcano <- as.factor(str_c(volcano_frequent7$volcano_name, "-", volcano_frequent7$vei))

volcano_frequent_total <- tibble(rbind(volcano_frequent0, volcano_frequent1, volcano_frequent2, volcano_frequent3, volcano_frequent4, volcano_frequent5,
      volcano_frequent6, volcano_frequent7))

frequency_plot <- volcano_frequent_total %>% 
  ggplot() +
  geom_tile(aes(x = lag_year,
                y = volcano),
            fill = "red") +
  ggtitle("Frequency of Most Active Volcanoes in each VEI category") +
  theme(plot.title = element_text(face = "bold",
                                  size = 15))

t2 <- volcano_frequent_total %>% 
  distinct(volcano, .keep_all = TRUE) %>% 
  select(volcano, frequency) 

t2$volcano <- factor(t2$volcano, levels = c("Kilauea-0", "Tambora-7","Krakatau-6","Agung-5", "Kelut-4",  "Bezymianny-3", "Asosan-2", "Etna-1"))





```


```{r, fig.align="center", fig.width = 13}
t2<- tableGrob(t2, theme=ttheme_minimal(), rows=NULL)

grid.arrange(frequency_plot, t2, ncol = 2,
             widths = c(80,20),
             padding = 2)
```

The tiles above plot the frequency of the Most Active Volcano in each VEI Category. Each tile represents an eruption.








# References
