---
title: "ETC5521 Assignment 1"
subtitle: "Your title"
team: Possum
author:
  - Samuel Lyubic
  - Yuheng 
date: "`r Sys.Date()`"
bibliography: references.bib
biblio-style: authoryear-comp
output: 
  bookdown::html_document2
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE,
                      fig.align = "center")
library(tidyverse)
library(lubridate)
library(broom)
library(leaflet)
library(ggmap)
library(mapview)
library(viridis)
library(rgdal)
library(kableExtra)
library(gridExtra)
library(readr)
library(knitr)
library(sf)
library(data.table)
library(ggthemes)
library(maps)
library(rvest)
library(patchwork)

```


```{r getting-data, echo=FALSE, include=FALSE}
# Get the Data
volcano <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/volcano.csv')
eruptions <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/eruptions.csv')
events <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/events.csv')
tree_rings <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/tree_rings.csv')
sulfur <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/sulfur.csv')

# tectonic plates coordinates
rof <- read_csv("all.csv")
```


# Introduction and motivation

Volcanoes date back to hundreds and thousands of years ago where the first documented eruption occurred in [Santorini back in 1650 BC!](https://books.google.com.au/books?hl=en&lr=&id=pcucBAAAQBAJ&oi=fnd&pg=PP1&dq=volcanoes&ots=k2yBX9ZjWf&sig=bG4X4uLpUyqGG4DQH8BTgI7AK58&redir_esc=y#v=snippet&q=first%20eruption&f=false) Accompanied by its mysterious image in our eyes, volcanoes touch on a wide range of knowledge, including geochemistry, petrology, seismology and more. This topic seems to be complex and distant from people like us who did not take further studies on this area. Yet we chanced upon data set released by `TidyTuesday` which is probably one of if not the most comprehensive data set to learn more about volcanoes. This data exploration enable us to take a closer look at the more recent active volcanoes around. 

Although volcanoes are nature's explosive land forms and yet one of the most beautiful, it is inevitable for us, as human being to neglect its impact on our lives. Based on our understanding on volcanoes, we develop two themes that will be surrounding this entire analysis, which are "severity" and "safety" so as to establish more interesting facts!

We start with a brief introduction into the world of volcanoes, then visit the interaction between volcano & humans and finally looking into the characteristics of volcano.

 
# Data description
The data source is from [The Smithsonian Institution](https://volcano.si.edu/), which has been constantly updating since 2013. The data is cleaned and made available for download on (https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md), so that we directly import the 5 data sets for this analysis. These 5 data sets are probably the most comprehensive data set around. They are volcano, eruptions, events, tree_rings and sulfur, allowing us to discover the influences among them. 

The data source is from [The Smithsonian Institution](https://volcano.si.edu/). The data is available, and cleaned, downloadable from [tidytuesday github](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md). Cleaning script is also supplied.


Data provided contains 5 linked data sets, each with looking at a particular aspect of volcano:  

- `volcano`: Provides information on 958 volcanoes such as
- `volcano`: Provides location, geological and population information on 958 volcanoes with 26 variables such as
  - its metadata: volcano name, type, country location, evidence category, longitude and latitude
  - technical details: major & minor rocks, tectonic settings
  - distance from nearest population (km)
  - Missing data in ""last_eruption_year", "major_rock" and "minor_rock", labelled as "unknown" or left as blank

- `eruptions`: Details eruptions occured since Holecene period (11,345 years ago) to present, comprising of 15 variables. Details include  
  - VEI (volcano explosivity index) as an indication for the severity of eruptions in ascending order, taking values from 0 to 7 
  - date of eruption, eruption category/type, evidence method
  - Unknown data appears commonly among variables "area_of_activity", "start_month", "start_day", "end_year", "end_month" and "end_day", denoted with "NA".

- `events`: any event that occur at the volcanoes documented with 10 variables.
  - such as explosion, dome/cone formation, fatalities, evacuation, loud audible noises among others.
  - Despite variables such as "event_type" and "event_remark" , a lot of its variables (e.g. eruption dates) overlap with that of `eruptions`, thus it seems as a condensed version of `eruptions`.
  - "NA" are presented regularly for "event_remarks" and mostly event dates information.

- `tree_ring`: Tree rings were used as a climate proxy. In study of effects on volcanoes on climate change, researchers matched effects of eruptions to tree ring records. The measurements are conducted yearly and no data is missing. Threre will be more discussion about `tree_ring` later.  

- `sulfur`
  - Provide information on sulphur detected from 500.CE to 706.CE with 3 variables.
  - Using the same unit for measurement, the data for "neem" is collected from Greenland while it is from Anatartica for "wdc".

# Research questions
- Primary:
  Does volcanoes with different VEI have specific characteristics?

- Secondary:
  How worried should you be about a volcano eruption?
  Which tectonic settings have higher or lower VEI and how this relates to the duration of eruption?
  What is the ideal setting for a volcano to form?
  
# Analysis and findings

## World Of Active Volcanoes

```{r volcano, include = FALSE}
#types of volcanoes
volcano %>% 
  count(primary_volcano_type) 

# categorize volcanoes into 4 main types
volcano_types <- volcano %>% 
  mutate(primary_volcano_type = case_when(
    str_detect(primary_volcano_type, "Stratovolcano") ~ "Stratovolcano",
    str_detect(primary_volcano_type, "Shield") ~ "Shield",
    str_detect(primary_volcano_type, "Caldera") ~ "Caldera",
    TRUE ~ "Other"
  ))

volcano_types %>% 
  count(primary_volcano_type)

unique(volcano_types$primary_volcano_type)
```


### World Map of Active Volcanoes erupt

```{r volcano-erupted, include = FALSE}
# join only volcanoes that erupted
volcano_erupted <-inner_join(volcano_types, eruptions) %>%
  # select relevant variables
  select(volcano_name, vei, start_year, end_year, last_eruption_year, primary_volcano_type, country, latitude, longitude, elevation, evidence_category, population_within_5_km, population_within_10_km, population_within_30_km, population_within_100_km) %>% 
# concatenate country & volcano name
  mutate(volcano = str_c(volcano_name, country, sep = " -"), .keep = "all",
         pop_5k = case_when(population_within_5_km <= 0 ~ "<= 100",
                            population_within_5_km >= 101 & population_within_5_km <= 1000 ~ "101 - 1,000",
                            population_within_5_km >= 1001 & population_within_5_km <= 10000 ~ "1,001 - 10,000",
                            population_within_5_km >= 10001 & population_within_5_km <= 100000 ~ "10,001 - 100,000",
                            population_within_5_km >= 100001 & population_within_5_km <= 1000000 ~ "100,001 - 1,000,000",
                            population_within_5_km >= 1000001 ~ "> 1,000,001"),
         pop_5k = as.factor(pop_5k)) 

# summarize volcano erupted; keeping all columns
volcano_erupted <- volcano_erupted %>% 
  group_by(volcano) %>%
  # find count (i.e. no. of times volcano erupted)
  mutate(n = n()) %>%  
  distinct(volcano, 
           .keep_all = TRUE) %>% 
  ungroup()
```

```{r volcano-types-eruptions, fig.cap = "Number of eruptions for Primary Volcano Types"}
# No. of eruptions by Volcano tyepes
volcano_erupted %>% 
  group_by(primary_volcano_type) %>% 
  summarize(no_of_eruptions = sum(n)) %>% 
  arrange(-no_of_eruptions) %>% 
  ggplot() +
  geom_col(aes(x = reorder(primary_volcano_type, -no_of_eruptions),
               y = no_of_eruptions),
           width = 0.1,
           space = 0.1,
           fill = "orange") +
  labs(x = "Primary Volcano Types",
       y = "Number of eruptions") +
  theme_minimal() +
  theme(axis.text = element_text(colour = "white"),
        axis.title = element_text(colour = "white")) +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) 
  
```

There are 3 main types of Active(erupted before) Volcanoes namely Stratovolcano, Caldera and Shield. We decided to label the others as `others`. Stratovolcanoes are by far the most active volcano. 

```{r plates, include = FALSE}
plate <- unique(rof$plate) %>% 
  tibble(plate = .)

# convert to sf object & split into 2 polygons (to prevent across dateline)
plates <- purrr::map(.x = plate$plate,
    .f = function(x){
      st_polygon(x = list(as.matrix(rof %>% filter(plate == x) %>%  select(lon, lat)))) %>% 
  st_wrap_dateline()
    }) 

# convert polygons back to dataframe
plates2 <- lapply(seq_along(plates), 
                 function(i) as.data.frame(plates[[i]][[1]]) %>% 
                   mutate(group = i)) %>%
  data.table::rbindlist() %>% 
  rename(lon = V1, lat = V2) 
```


```{r world-map, fig.cap = "Active Volcanoes and The Ring of Fire, and Tectonic Plates layourt across the globe", fig.width=14, fig.height=14}
world <- map_data("world")

# add continent coordinates
continent_coord <- tibble(id = c("Africa", "Asia", "Europe", "North America", "Oceania", "South America"),
                          long = c(15, 80, 20, -100, 150, -60),
                          lat = c(15, 35, 50, 40, -25, -15),
                          stringsAsFactors = F)

# add ring of fire coordinates
ring_of_fire <- tibble(id = c("Pacific Ocean", "Pacific Ocean"), 
                    long = c(180, -180),
                    lat = c(35, 35))

# ----- plot world map
w1 <- world %>% 
  ggplot() +
  geom_map(map = world,
           aes(x = long, y = lat,
               map_id = region),
           fill = "dark grey") +
  geom_point(data = volcano_erupted,
             aes(x = longitude, y = latitude,
                 shape = primary_volcano_type),
             colour = "orange",
             fill = "red",
             size = 5) +
  scale_shape_manual(values = c(22, 23, 24, 20)) +
  theme(legend.position = "bottom") +
  labs(subtitle = "World map of volcanoes with documented eruptions") +
  # add continent text
  geom_text(data = continent_coord,
            aes(x = long, 
                y = lat,
                label = id),
            colour = "blue",
            size = 5) +
  geom_label(data = ring_of_fire,
            aes(x = long, 
                y = lat,
                label = id),
            colour = "blue") +
  # remove legends
  guides(colour = FALSE,
         size = FALSE,
         alpha = FALSE) +
  ggtitle("Active Volcanoes and The Ring of Fire") +
  theme_map() +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) 
  
w2 <- world %>% 
  ggplot() +
  geom_map(map = world,
           aes(x = long, y = lat,
               map_id = region),
           fill = "dark grey") +
  geom_polygon(data = plates2,
               aes(x = lon,
                   y = lat,
                   group = group),
               fill = NA,
               colour = "dark green",
               size = 2) +
  geom_text(data = continent_coord,
            aes(x = long, 
                y = lat,
                label = id),
            colour = "blue",
            size = 5) +
  geom_label(data = ring_of_fire,
            aes(x = long, 
                y = lat,
                label = id),
            colour = "blue") +
  # remove legends
  guides(colour = FALSE,
         size = FALSE,
         alpha = FALSE) +
  ggtitle("Tectonic Plates layourt across the globe") +
  theme_map() +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) 
  
grid.arrange(w1, w2, nrow = 2)

```

Figure \@ref(fig:world-map) displays two maps, one showing the Active Volcanoes and the ring of fire and the other showing the layour of tectonic plate boundaries. 

We found that most of the volcanoes lie along the Pacific Ocean tracing the boundaries of tectonic plates, this is known as the 'Ring of Fire' [@ngs]. This path is approximately 40,000km long and holds 75% of the World's Volcanoes with 90% of them being active. The abundance of volcanoes are explained by significant tectonic plates in the area, as volcanoes are formed through the cracking in the ground created by converging or diverging tectonic plate boundaries. 


```{r ring-of-fire, fig.cap = "The Ring of Fire", fig.height=8, fig.width=14}
# ---- fix longitude; recenter coordinates to center around ring of fire
volcano_erupted <- volcano_erupted %>% 
  mutate(long_fixed = ifelse(longitude < 0, yes = longitude + 360, no = longitude)) %>% 
  filter(long_fixed > 60 & long_fixed < 320,
         latitude > -50) 
  
# --- plot world map with Pacific Ocean in the middle 
world2 <- map_data("world2") %>% 
  # filter to coordinates within ring of fire
  filter(long > 60 & long < 320)

# --- plot prominent countries coordinates
countries_rof_coord <- tibble(id = c("Australia", "New Zealand", "South America", "North America", "Japan"), long = c(130, 174, 310, 265, 140), lat = c(-25, -40, -20, 50, 33))

ggplot() +
  # plot world map
  geom_polygon(data = world2,
               aes(x = long, y = lat, group = group),
               fill = "dark grey") +
  # plot active volcanoes points
  geom_point(data = volcano_erupted,
               aes(x = long_fixed, y = latitude,
                   size = n),
             colour = "red") +
  scale_size(range = c(2,5), 
             breaks = c(10, 50, 100, 180),
             name = "Number of eruptions") +
  geom_text(data = countries_rof_coord,
            aes(x = long, y = lat, label = id),
            colour = "blue") +
  labs(subtitle = "Pacific Rim Volcanoes with documented eruptions") +
  theme_map() +
  annotate("text", x = 200, y = 30,
           label = "Ring of Fire",
           colour = "pink",
           family = "Palatino",
           size = 9) +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20"),
        legend.box.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange"))
```

This map zoomed into the Ring Of Fire, showing the volcanoes running along the boundaries. Relatively speaking, the volcanoes here have more eruptions.

## The interaction between volcanoes and humans - How worried should you be about volcanoes?

### Population around volcanoes' vicinity

```{r plotpop-exploration, include = FALSE}
volcano_erupted %>% 
  summarize(mean_5km = summary(population_within_5_km),
            mean_10km = summary(population_within_10_km),
            mean_30km = summary(population_within_30_km),
            mean_100km = summary(population_within_100_km))

volcano_population <- volcano_erupted %>% 
  mutate(no_of_people_5km = case_when(population_within_5_km <= 100 ~ "<= 100", 
                                  population_within_5_km >= 101 & population_within_5_km <= 1000 ~ "101-1,000",
                                  population_within_5_km > 1000 & population_within_5_km <= 10000 ~ "1,001-10,000",
                                  population_within_5_km > 10000 & population_within_5_km <= 100000 ~ "10,000-100,000",
                                  population_within_5_km > 100000 & population_within_5_km <= 1000000 ~ "100,001-1,000,000",
                                  population_within_5_km > 1000000 ~ "> 1,000,000")) 

volcano_population <- volcano_population %>% 
  mutate(no_of_people_10km = case_when(population_within_10_km <= 100 ~ "<= 100", 
                                  population_within_10_km >= 101 & population_within_10_km <= 1000 ~ "101-1,000",
                                  population_within_10_km > 1000 & population_within_10_km <= 10000 ~ "1,001-10,000",
                                  population_within_10_km > 10000 & population_within_10_km <= 100000 ~ "10,000-100,000",
                                  population_within_10_km > 100000 & population_within_10_km <= 1000000 ~ "100,001-1,000,000",
                                  population_within_10_km > 1000000 ~ "> 1,000,000")) 


volcano_population <- volcano_population %>% 
  mutate(no_of_people_30km = case_when(population_within_30_km <= 100 ~ "<= 100", 
                                  population_within_30_km >= 101 & population_within_30_km <= 1000 ~ "101-1,000",
                                  population_within_30_km > 1000 & population_within_30_km <= 10000 ~ "1,001-10,000",
                                  population_within_30_km > 10000 & population_within_30_km <= 100000 ~ "10,000-100,000",
                                  population_within_30_km > 100000 & population_within_30_km <= 1000000 ~ "100,001-1,000,000",
                                  population_within_30_km > 1000000 ~ "> 1,000,000")) 

volcano_population <- volcano_population %>% 
  mutate(no_of_people_100km = case_when(population_within_100_km <= 100 ~ "<= 100", 
                                  population_within_100_km >= 101 & population_within_100_km <= 1000 ~ "101-1,000",
                                  population_within_100_km > 1000 & population_within_100_km <= 10000 ~ "1,001-10,000",
                                  population_within_100_km > 10000 & population_within_100_km <= 100000 ~ "10,000-100,000",
                                  population_within_100_km > 100000 & population_within_100_km <= 1000000 ~ "100,001-1,000,000",
                                  population_within_100_km > 1000000 ~ "> 1,000,000")) 

volcano_population_long <- volcano_population %>% 
  pivot_longer(cols = no_of_people_5km:no_of_people_100km,
               names_to = "category",
               values_to = "no_of_people") %>% 
  mutate(no_of_people = factor(no_of_people, levels = c("<= 100", "101-1,000", "1,001-10,000", "10,000-100,000", "100,001-1,000,000", "> 1,000,000")))

volcano_population_long$category <- factor(volcano_population_long$category, levels = c("no_of_people_100km", "no_of_people_30km", "no_of_people_10km", "no_of_people_5km"))

pop_plot <- volcano_population_long %>% 
  group_by(category) %>% 
  ggplot() +
  geom_bar(aes(x = as.factor(no_of_people)),
           fill = "orange") +
  facet_wrap(~category, ncol = 1) +
  coord_flip() +
  ylab("categories (number of people)") +
  xlab("count") +
  theme_void() +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange")) +
  theme(axis.title.x = element_text(colour = "white"),
        axis.text.x = element_text(colour = "white"),
        axis.text.y = element_text(colour = "white",
                                   hjust = 1),
        axis.title = element_text(colour = "white"))

```



```{r triangles-fun, fig.cap = "Population within 5, 10, 30, 100km from Volcano", fig.height=12, fig.width=18}
dt.triangle <- data.table(group = c(1,1,1,
                                    2,2,2,
                                    3,3,3,
                                    4,4,4,
                                    5,5,5,
                                    6,6,6,
                                    
                                    7,7,7,
                                    8,8,8,
                                    9,9,9,
                                    10,10,10,
                                    11,11,11,
                                    12,12,12,
                                    
                                    13,13,13,
                                    14,14,14,
                                    15,15,15,
                                    16,16,16,
                                    17,17,17,
                                    18,18,18,
                                    
                                    19,19,19,
                                    20,20,20,
                                    21,21,21,
                                    22,22,22,
                                    23,23,23,
                                    24,24,24),
                                    
                          polygon.x = c(0,2,1,
                                        3,5,4,
                                        6,8,7,
                                        9,11,10,
                                        12,14,13,
                                        15,17,16,
                                        
                                        0,2,1,
                                        3,5,4,
                                        6,8,7,
                                        9,11,10,
                                        12,14,13,
                                        15,17,16,
                                        
                                        0,2,1,
                                        3,5,4,
                                        6,8,7,
                                        9,11,10,
                                        12,14,13,
                                        15,17,16,
                                        
                                        0,2,1,
                                        3,5,4,
                                        6,8,7,
                                        9,11,10,
                                        12,14,13,
                                        15,17,16),
                          
                          polygon.y = c(0,0,22.6,
                                        0,0,13.3,
                                        0,0,11.3,
                                        0,0,4.5,
                                        0,0,0.7,
                                        
                                        32.6,32.6,32.6 + 16.2,
                                        32.6,32.6,32.6 + 9.9,
                                        32.6,32.6,32.6 + 12.2,
                                        32.6,32.6,32.6 + 11.6,
                                        32.6,32.6,32.6 + 3.2,
                                        32.6,32.6,32.6 + 0.7,
                                        
                                        58.8,58.8,58.8 + 9.2,
                                        58.8,58.8,58.8 + 6.2,
                                        58.8,58.8,58.8 + 10.9,
                                        58.8,58.8,58.8 + 9.5,
                                        58.8,58.8,58.8 + 12.4,
                                        58.8,58.8,58.8 + 5.6,
                                        
                                        81.2,81.2,81.2 + 3.7,
                                        81.2,81.2,81.2 + 2.6,
                                        81.2,81.2,81.2 + 5.9,
                                        81.2,81.2,81.2 + 6.7,
                                        81.2,81.2,81.2 + 13.7,
                                        81.2,81.2,81.2 + 21.2))
                                        
text <- tibble(id = c("Population within 5km", "Population within 10km", "Population within 30km", "Population within 100km"), 
               x = rep(9.5,4),
               y = c(22.6 + 2, 32.6+16.2+2, 58.8+12.4+2, 81.2+21.2+2))

no_of_people_comment1 <- tibble(id = rep("<=100", 4),
                               x = rep(1,4),
                               y = c(-2,30.6,56.8,79.2)) # -2

no_of_people_comment2 <- tibble(id = rep("101-1,000", 4),
                               x = rep(4,4),
                               y = c(-2,30.6,56.8,79.2))

no_of_people_comment3 <- tibble(id = rep("1,001-10,000", 4),
                               x = rep(7,4),
                               y = c(-2,30.6,56.8,79.2))

no_of_people_comment4 <- tibble(id = rep("10,000-100,000", 4),
                               x = rep(10,4),
                               y = c(-2,30.6,56.8,79.2))

no_of_people_comment5 <- tibble(id = rep("100,001-1,000,000", 4),
                               x = rep(13,4),
                               y = c(-2,30.6,56.8,79.2))

no_of_people_comment6 <- tibble(id = rep("> 1,000,000", 4),
                               x = rep(16,4),
                               y = c(-2,30.6,56.8,79.2))


no_of_volcanoes_text <- tibble(id = c("226 volcanoes", "162 volcanoes", "92 volcanoes", "37 volcanoes"),
                               x = rep(1,4),
                               y = c(-4,28.6,54.8,77.2))

no_of_volcanoes_text2 <- tibble(id = c("133 volcanoes", "99 volcanoes", "62 volcanoes", "26 volcanoes"),
                               x = rep(4,4),
                               y = c(-4,28.6,54.8,77.2))


no_of_volcanoes_text3 <- tibble(id = c("113 volcanoes", "122 volcanoes", "109 volcanoes", "59 volcanoes"),
                               x = rep(7,4),
                               y = c(-4,28.6,54.8,77.2))

no_of_volcanoes_text4 <- tibble(id = c("45 volcanoes", "116 volcanoes", "95 volcanoes", "67 volcanoes"),
                               x = rep(10,4),
                               y = c(-4,28.6,54.8,77.2))

no_of_volcanoes_text5 <- tibble(id = c("14 volcanoes", "32 volcanoes", "124 volcanoes", "137 volcanoes"),
                               x = rep(13,4),
                               y = c(-4,28.6,54.8,77.2))

no_of_volcanoes_text6 <- tibble(id = c("7 volcanoes", "7 volcanoes", "56 volcanoes", "212 volcanoes"),
                               x = rep(16,4),
                               y = c(-4,28.6,54.8,77.2))

triangle <- ggplot() +
  geom_polygon(data = dt.triangle,
               aes(x = polygon.x, y = polygon.y, group = group),
               fill = "orange") +
  geom_text(data = text,
            aes(x = x, y = y, label = id),
            size = 8,
            colour = "white") +
  theme_void() +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) +
  geom_text(data = no_of_people_comment1,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
   geom_text(data = no_of_people_comment2,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
  geom_text(data = no_of_people_comment3,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
   geom_text(data = no_of_people_comment4,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
  geom_text(data = no_of_people_comment5,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
  geom_text(data = no_of_people_comment6,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "white") +
 
  geom_text(data = no_of_volcanoes_text,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
  geom_text(data = no_of_volcanoes_text2,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
  geom_text(data = no_of_volcanoes_text3,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
  geom_text(data = no_of_volcanoes_text4,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
    geom_text(data = no_of_volcanoes_text5,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") +
  geom_text(data = no_of_volcanoes_text6,
            aes(x = x, y = y, label = id),
            size = 6,
            colour = "red") 

grid.arrange(triangle, pop_plot, ncol = 2,
             widths = c(0.7, 0.3))
   

```

Figure \@ref(fig:triangles-fun) displays the size of volcanoes as represented by the triangles and their proximity to the nearest population, broken down into 5km, 10km, 30km and 100km.

  - Population size with 5km is mostly less tehn 100
  - However, within a 10km range there is quite a bit of variability in the sizes of the populations in that range.

The impact of a volcano can vary in their destructive nature, creating both immediate and long term risks to the surrounding and global populations. The immediate risk to the surrounding populations come in the physical form of:
  
  - _Pyroclastic flows_, which is the extremely hot chaotic mixture of rock fragments, gas, and ash that travels rapidly from an eruption and destroys whats in its path
  - _Projectile fragments_, fragments of rock that can travel anywhere from 100m to 25km depending on the size and magnitude of the eruption
  - _Heavy ash_ which are clouds consisting of small particles of gases and rocks around the 2mm in size, that are released into the atmosphere and then landing on the ground.
  
Size of a volcano can be an indicator of the potential damage that could come from an eruption given the positioning and greater velocity that can be prodcued from a larger volcano however, there is no way to create a blanket safe distance rule when it comes to their damage radius is the impact of a volcano uniqely dependent on each individual eruption. Generally, 5-10km range is relatively safe for residincy given the size of most eruptions however, as only an exceptional eruption would result in severe in that range, although these "exceptional eruptions" are not too uncommon for residents who decide to live in this proximity to setup imobile residencies. [Volcanic Discovery](https://www.volcanodiscovery.com/volcanic_risk_zones.html#:~:text=4)%20Low%20Risk%20Zone&text=Typically%20you%20are%20more%20than,pyroclastic%20flows%20could%20be%20channeled.)    

Figure \@ref(fig:triangles-fun) was inspired by [Sil Aarts'](https://twitter.com/sil_aarts/status/1260156344319041537/photo/1) visualization where we use `geom_polygon` to create easy and intuitive visualizations.

### World map with number of eruptions in each country
#####REMOVED volcano-erupted-countries Plot
```{r volcano-erupted-countries, fig.height=8, fig.width=14, eval = FALSE}
volcano_erupted %>% 
  arrange(-n) %>% 
  head(10) %>% 
  ggplot() +
  geom_col(aes(x = reorder(volcano, -n),
               y  = n),
           width = 0.1,
           space = 0.1,
           fill = "orange") +
  labs(x = "Volcano",
       y = "Number of eruptions") +
  ggtitle("Top 10 Most Active Volcanoes") +
  theme_minimal() +
  theme(axis.text = element_text(colour = "white",
                                 size = 12),
        axis.text.x = element_text(angle = 45),
        axis.title = element_text(colour = "white",
                                  size = 18)) +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) + 
  theme(plot.title = element_text(size = 20, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) 
  
  
```


```{r volcano-countries, fig.cap = "World Map with countries experiencing most eruptions", fig.height=8, fig.width=14}
# clean volcano$country to match world data set
volcano_country <- volcano_erupted %>% 
  mutate(country = case_when(
    country == "Armenia-Azerbaijan" ~ "Armenia",
    country == "Burma (Myanmar)" ~ "Burma",
    country %in% c("Chile-Argentina","Chile-Bolivia", "Chile-Peru") ~ "Chile",
    country == "China-North Korea" ~ "China",
    country == "Colombia-Ecuador" ~ "Colombia",
    country %in% c("DR Congo", "DR Congo-Rwanda") ~ "Democratic Republic of the Congo",
    country == "El Salvador-Guatemala" ~ "El Salvador",
    country == "Eritrea-Djibouti" ~ "Eritrea",
    country %in% c("Ethiopia-Djibouti", "Ethiopia-Kenya") ~ "Ethiopia",
    country == "Guatemala-El Salvador" ~ "Guatemala",
    country == "Japan - administered by Russia" ~ "Japan",
    country == "Mexico-Guatemala" ~ "Mexico",
    country == "North Korea-South Korea" ~ "North Korea",
    country == "Saint Kitts and Nevis" ~ "Saint Kitts",
    country == "Syria-Jordan-Saudi Arabia" ~ "Syria",
    country == "Saint Vincent and the Grenadines" ~ "Saint Vincent",
    country == "Uganda-Rwanda" ~ "Uganda",
    country == "United Kingdom" ~ "UK",
    country == "United States" ~ "USA",
    TRUE ~ country
  )) 

volcano_country_count <- volcano_country %>% 
  group_by(country) %>% 
  count() %>% 
  ungroup()

world <- map_data("world")

volcano_country_join <- left_join(world, volcano_country_count,
          by = c("region" = "country")) %>% 
  # replace n = NA to 0
  mutate(n = ifelse(is.na(n), 0, n))

b0 <- eruptions %>%
  na.exclude(vei, start_year) %>%
  group_by(start_year) %>%
  select(volcano_number, volcano_name, vei, latitude, longitude, start_year) %>%
  count(volcano_number, volcano_name, vei, latitude, longitude) %>%
  arrange(desc(n)) 

b0 <- b0 %>%mutate(`Total eruption` = sum(b0$n)) 

pal2 <- colorFactor(
  palette = c('yellow', 'orange', 'red', 'dark red', "brown", "purple"),
  domain = b0$vei
)


# plot world map; fill number of volcanoes that erupt in each country 
#add color mapping by region 
volcano_country_join %>% 
  ggplot() +
  geom_map(map = volcano_country_join,
           aes(x = long, y = lat, map_id = region,
               fill = n)) +
  scale_fill_gradient(low = "dark grey",
                      high = "#ff8000",
                      name = "number of eruptions") +
  # plot dot points representing active volcanoes
  geom_point(data = volcano_erupted,
             aes(x = longitude, y = latitude,
                 size = population_within_5_km),
                 colour = "blue",
             alpha = .1) +
  scale_size(range = c(2,7),
            name = "Population Within 5km",
            breaks = c(100, 1000, 10000, 100000, 1000000, 40640105),
            labels = c("<=100", "101-1000", "1001-10,000", "10,001-100,000", "100,001-1,000,000", ">1,000,000")) +
  theme(panel.background = element_rect(fill = "grey20"),
        plot.background = element_rect(fill = "grey20"),
        legend.box.background = element_rect(fill = "grey20"),
        legend.text = element_text(colour = "white"),
        legend.title = element_text(colour = "white")) +
  theme(legend.position = "right",
        legend.background = element_rect(fill = "grey20")) +
  theme(plot.title = element_text(size = 25, face = "bold", colour = "orange"),
        plot.subtitle = element_text(size = 16, colour = "orange")) +
  annotate("label", x = -100, y = 40,
           label = "North America",
           colour = "blue",
           family = "Palatino",
           size = 4) +
  annotate("label", x = 140, y = 33,
           label = "Japan",
           colour = "blue",
           family = "Palatino",
           size = 4) +
  annotate("label", x = 105, y = -10,
           label = "Indonesia",
           colour = "blue",
           family = "Palatino",
           size = 4) +
  annotate("label", x = -80, y = -35,
           label = "Chile",
           colour = "blue",
           family = "Palatino",
           size = 4) +
  annotate("label", x = 130, y = 60,
           label = "Russia",
           colour = "blue",
           family = "Palatino",
           size = 4)
```

Figure \@ref(fig:volcano-countries) displays the locations of volcanoes with a populations within a 5km radius, with the size of the population mapped to size of the point and orange scale indicating the number of volcano eruptions across the glove. with fill depending on the number of eruptions in each country and larger dot sizes represent the number of population in the vicinity. 

  - Most of the countries with higher counts of eruptions lie along the edges of the pacifc ocean, which is known as the "Ring of Fire"
  - The countries along the "Ring of Fire", specifically Noth America, Chile, Indonesia and Japan have the highest number of populations near the more active volcano sites. Inicating that, living in those countries along the pacific ocean poses a potential higher risk to those individuals relative to those living more inland.[https://www.usgs.gov/faqs/what-ring-fire?qt-news_science_products=0#]

## Can volcano eruptions predict climate change?
## How sulfate levels and eruption cycles can be used to predict climate change?


The following section will be conducting analysis on volcano eruptions in order to assess how the elements of en eruption may impact the atmosphere and the resulting impact on climate. 

As discussed, a volcanic eruption can vary in VEI magnitude and range in the substances that are released however, a constant element that is emitted during eruption is Sulfur, which is subsequently also one of the most effective elements in cooling the climate. When sulfur is released into the stratosphere it combines with water to form sulfuric acid aerosols that produce a coating of small droplets in the upper stratosphere which act as a reflector to incoming solar radiation and result in a global coolng of the earths surface, with the aerosols able to stay in the statrosphere for up to 3 year, eventually falling back to earth. Furthermore, as discussed tree ring scores can be used to act as a proxy in order to understand the weather at the time thus by assessing the linearage of sulfur events and tree ring scores the impact of volcanic eruptions on climate change can be assessed [https://scied.ucar.edu/shortcontent/how-volcanoes-influence-climate].

The primary variables being used to assess the sulfur levels, in nannograms per gram, in the northern and southern hemisphere across the date range of 500-705 ce are:

  1. NEEM - ice cores from Greenland
  2. WDC - ice cores from Antartica
  
Given the stable ice sheets as well as the earths rotation and locations of Greenland and Anatartica, the ice sheets abosrb and store the elements released during events in history and the NEEM and WDC team have been able to extract ice sheets that store records of atmospheric concentration of greenhouse gases, surface air temperature. Sulfur being one of these elements, thus the ice cores allow for a construction of a time series of the level of a sulfur at any given year thus allowing a reconstruction of when sulfuric events in the form of eruptions took place. [https://neem.dk/#:~:text=The%20North%20Greenland%20Eemian%20Ice,the%20previous%20interglacial%2C%20the%20Eemian.] [https://www.waisdivide.unh.edu/]

The histroic time frame provides critical information on the history of eruptions and sulfuric events thus allowing to better understand what caused certain events in history, such as ice ages and prolonged periods of cooling, and long term effects of sulfuric depositions impact the earth in order to better understand the likey outcome on climate from an eruption and how to plan accordingly. [https://www.researchgate.net/publication/279965759_Timing_and_climate_forcing_of_volcanic_eruptions_for_the_past_2500_years] 


```{r}
#fitlering tree ring for appropriate date range to compare with sulfate levels
#ce refers to the time period 
t_rings_ce <- tree_rings %>%
  filter(year >= 500 & year <= 730)


#combinig volcano dataset with eruptions to produce a data set that shows the volcano details for the eruptions that took place during the recorded sulfate time frame
eruptions_ce <- eruptions %>%
  filter(start_year >= 500 & start_year <= 730)

volcano_eruptions_ce <- eruptions_ce %>%
  inner_join(volcano, by = "volcano_number") %>%
  select(volcano_number, volcano_name.x, eruption_category, start_year, primary_volcano_type, country, region, subregion, latitude.x, longitude.x, elevation, vei) %>%
  rename(latitude = latitude.x,
         longitude = longitude.x,
         volcano_name = volcano_name.x) 

#add north or south hemisphere to table
volcano_eruptions_hemisphere <- volcano_eruptions_ce %>%
  mutate(hemisphere = 
           case_when(latitude > 0 ~ "Northern",
                     latitude < 0 ~ "Southern")) %>%
  select(volcano_name, eruption_category, start_year, country, hemisphere, vei, primary_volcano_type) %>%
  rename(year = start_year)

volcano_eruptions_hemisphere_3 <- volcano_eruptions_hemisphere %>%
  filter(vei >= 3)

tree_rings_long <- t_rings_ce %>%
  pivot_longer(c("n_tree", "europe_temp_index"),
               names_to = "index",
               values_to = "value") %>%
  mutate(year_ce = year + .990)

sulfur_yearly_means <- sulfur %>%
  mutate(year_ce = str_sub(year, start = 0, end = 3)) %>%
  select(-year) %>%
  rename(year = year_ce) %>%
  group_by(year) %>%
  summarise(mean_neem = mean(neem),
            mean_wdc = mean(wdc)) %>%
  mutate(year = as.numeric(year))

percent_change <- t_rings_ce %>%
  left_join(sulfur_yearly_means, by ="year") %>%
  arrange(year) %>%
  filter(year <= 705) %>%
  mutate(n_tree_pct_change = (n_tree/lag(n_tree) - 1)*100,
         euro_temp_pct_change = (europe_temp_index/lag(europe_temp_index) - 1)*100,
         mean_neem_pct_change = (mean_neem/lag(mean_neem ) - 1)*100,
         mean_wdc_pct_change = (mean_wdc/lag(mean_wdc) - 1)*100)
```

```{r plot-variables}
p1 <- sulfur %>%
  mutate(year = as.numeric(year)) %>%
  ggplot(aes(x = year,
             y = neem)) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 200, 25)) +
  scale_x_continuous(breaks = seq(500, 705, 25)) +
  geom_vline(xintercept = c(540, 575, 682), colour ="blue", alpha = .5) +
  geom_vline(xintercept = c(520, 536, 574, 627, 550), colour ="green", alpha = .5) +
  labs(title = "Greenland NEEM Ice Core Sulfur Depositions",
       y = "Sulfur ng/g ",
       x = "Year",
       tags = "(B)") +
  theme_linedraw() +
  theme(panel.grid.minor.y=element_blank(),
           panel.grid.major.y=element_blank())

p2 <- sulfur %>%
  ggplot(aes(x = year,
             y = wdc)) +
  geom_line() +
  scale_y_continuous(breaks = seq(0, 200, 50)) +
  scale_x_continuous(breaks = seq(500, 705, 25)) +
  geom_vline(xintercept = c(540, 575, 682), colour ="blue", alpha =.5) +
  geom_vline(xintercept = c(683, 690, 653, 550), colour = "red", alpha = .5) +
  labs(title = "Antaric WDC Ice Core Sulfur Depositions",
       x = "Year",
       y = "Sulfur ng/g",
       tags = "(A)") +
  theme_linedraw() +
  theme(panel.grid.minor.y=element_blank(),
           panel.grid.major.y=element_blank())
  

t1 <- percent_change %>%
  ggplot(aes(x = year,
             y = n_tree)) +
  geom_line() +
  scale_color_viridis_d() +
  geom_vline(xintercept = c(540, 575, 682), colour ="blue", alpha = .5) +
  geom_vline(xintercept = c(520, 536, 574, 627, 550), colour ="green", alpha = .5) +
  geom_vline(xintercept = c(683, 690, 653), colour = "red", alpha =.5) +
  geom_hline(yintercept = 0, colour = "blue", alpha = .5) +
  scale_x_continuous(breaks = seq(500, 705, 25)) +
  labs(title = "Change in Tree Ring Z-scores",
       x = "Year",
       y = "T ring scores",
       tags = "(C)") +
  theme_linedraw() +
  theme(panel.grid.minor.y=element_blank(),
           panel.grid.major.y=element_blank())

t2 <- percent_change %>%
  ggplot(aes(x = year,
             y = euro_temp_pct_change)) +
  geom_line() +
  scale_color_viridis_d() +
  geom_vline(xintercept = c(540, 575, 682), colour ="blue", alpha = .5) +
  geom_vline(xintercept = c(520, 536, 574, 627, 550), colour ="green", alpha = .5) +
  geom_vline(xintercept = c(683, 690, 653), colour = "red", alpha =.5) +
  geom_hline(yintercept = 0, colour = "black", alpha = .5) +
  scale_x_continuous(breaks = seq(500, 705, 25)) +
  labs(title = "Percent change in euro temperature index",
       x = "Year",
       y = "Percentage %",
       tags = "(D)") +
  theme_linedraw() +
  theme(panel.grid.minor.y=element_blank(),
           panel.grid.major.y=element_blank())
```


```{r plot-ice-core, fig.cap = "Time series of the sulfur events that have been recorded in Greenland and Antartica and the European weather index and Tree Ring Z-Score", fig.width = 12}
p2 + p1 + t1 + t2 + plot_layout(nrow = 4)
```

Figure \@ref(fig:plot-ice-core) displays three plots with year on the x axis and, for (A) and (B), historically recorded sulfur levels on the y axis while for (C) and (D), percentage change:

  - Plot (A) visualises the recorded sulfur levels, in ng/g, in the extracted Antartic ice sheet from year 500 to 705 CE
  - Plot (B) visualises the recorded sulfur levels, in ng/g, in the extracted Greenland ice sheets from year 500 to 705 CE
  - Plot (C) visualises the change in tree ring score size from year to year
  - Plot (D) visualises the year on end percentage change in european temperature index
  - The red line indicating a volcanic eruption impacting the Southern hemisphere
  - The green vertical line indicating a volcanic eruption impacting the northern hemisphere
  - The blue vertical line indicating a bi-polar event impacting both hemispheres.
  
Looking at plot (A) and (B) the vertical lines indicate sulfuric events that the ice cores recorded and have been attributed to volcanic eruptions. Specifcally: 

  - Bipolar events: year 540, 575 and 682
  - Northern Hemisphere events: in year 520, 536, 550, 574 and 627
  - Southern Hemisphere events: in year 683, 690 and 653
  - It is important to note that Northern Hemisphere volcanic eruptions materials tend to stay only in the Northern hemisphere while Southern hemipshere volcanic elements have been found to be move north [https://www.smithsonianmag.com/science-nature/sixth-century-misery-tied-not-one-two-volcanic-eruptions-180955858/]
  
All these sulfur depositions have now been attributed to volcanic eruptions at the time [https://www.researchgate.net/publication/279965759_Timing_and_climate_forcing_of_volcanic_eruptions_for_the_past_2500_years] [https://www.smithsonianmag.com/science-nature/sixth-century-misery-tied-not-one-two-volcanic-eruptions-180955858/]. Asessing plot (C) and (D) from Figure \@ref(fig:plot-ice-core), it is evident that there is negative change and tree growth z scores and climate index that occur after the volcanic eruptions. Specifically:

 - Plot (C) shows an overall trend of drops in tree ring scores after a volcanis eruption and subsequent years of negative of negative tree ring scores.
    - Year 536 saw one of the most significant sulfur depostions from an eruoption in the northern hemisphere with a negative change of -4800% from 0.7 to 3.29. 
    - Interestingly, events in 574, 675, 627 and 690 are followed by growth in n tree ring size although still in the negative z score range.
    - However, subsequent years after sulfur events show growth was again negative which indicates the lag and long term impact that sulfur depoistion events have on the stratosphere, as they may not always immediately show an impact however given the length of time the sufur can stay in the stratosphere it shows a long term effect taking place [https://www.researchgate.net/publication/279965759_Timing_and_climate_forcing_of_volcanic_eruptions_for_the_past_2500_years]. 
    
  - Plot (D) displays the percentage change of the European temperature index, which displays a relatively  negative percentage year on end change in temperature after a volcanic event. 
    - Similarly to plot (C), there is a large negative percentage change of -1680% in the year 536 furthermore 
    - As the trend in plot (C) show, although in some cases the immediate impact of the volcnic event there is a lagged effect of an overall negative change from year to year in the weather index in the subsequent years after an event.   
  
### Correlation test

To supplement the analysis conducted on Figure \@ref(fig:plot-ice-core), a pearson correlation test was conducted on the tree scores and the yearly average NEEM and WDC sulfur level recordings.

```{r cor-neem-tree, fig.cap = "Correlation test between the tree ring scores and the yearly mean neem sulfur levels recorded"}
cor.test(x = percent_change$n_tree, y = percent_change$mean_neem, method = "pearson") %>%
  tidy() %>%
  kable(caption = "Tree ring score and yearly mean NEEM correlation test") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 
```
```{r cor-wdc-tree, fig.cap = "Correlation test between the tree ring scores and the yearly mean wdc sulfur levels recorded"}
cor.test(x = percent_change$n_tree, y = percent_change$mean_wdc, method = "pearson") %>%
  tidy() %>%
  kable(caption = "Tree ring score and yearly mean WDC correlation test") %>%
  kable_styling(bootstrap_options = c("hover", "striped")) 
```

The results from Table \@ref(tab:cor-neem-tree) and Table \@ref(tab:cor-wdc-tree) present a negative correlation between the tree ring sizes and the sulfur levels recorded by MEEN and WDC, with:
  - The correlation between tree rings and MEEN mean sulfur levels: -0.36.
  - The correlation between tree rings and WDC mean sulfur levels: -0.29.
  
Thus indicating that with increased sulfur levels tree ring size decreases and given tree rings act as a proxy for weather this leads to the notion that with event of a volcanic eruption taking and the subsequent release of the sulfur gases into the stratosphere there is likely to be both short term and long term climate impact with a global cooling period taking place.

### How prominent are high VEI scale eruptions?

VEI measures the explosiveness of volcanic eruptions which is determined by the volume of contents launched from the eruption. The contents is made up of pyroclastic flow, ash clouds, debrit and rocks with the eruption cloud height and volume being assessed as part of the measure. VEI is qualitatlively described using terms such ranging from "gentle" to "mega-colossal". [[Wikipedia](https://en.wikipedia.org/wiki/Volcanic_Explosivity_Index)]. 


```{r eruptions-1812-wrangling}
# filter eruptions; to after 1812: eruption of Mount Tambora
eruptions_1812 <- eruptions %>% 
  filter(start_year >= 1812) 

# see lag; between last eruption to next
eruptions_1812 <- eruptions_1812 %>% 
  arrange(start_year, volcano_name) %>%  
  group_by(volcano_name) %>% 
  # find year between eruptions = year of eruption + (time between last and start of eruption)
  mutate(lag_year = start_year + (lag(start_year) - start_year))
```


```{r eruptions-1812-pdf}
library(ggridges)
eruptions_1812_pdf <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  group_by(volcano_name, vei) %>% 
  mutate(no_of_eruptions = n(),
         vei = factor(vei, levels = c(0, 1, 2,3 ,4, 5, 6, 7))) 

eruptions_1812_pdf <- eruptions_1812_pdf %>% 
  ggplot() +
  stat_density_ridges(aes(y = factor(vei, levels = c(0,1,2,3,4,5,6,7)),
                          x = no_of_eruptions,
                          fill = vei),
                      # colour median line & adjust size
                      quantile_lines = TRUE,
                      vline_color = "red",
                      vline_size = 1.5,
                      quantiles = 0.5#,
                      # add jittered points
                      # jittered_points = TRUE,
                      # alpha = 0.7,
                      # position = "raincloud"
                      ) +
  scale_x_continuous(breaks = seq(from = 0, to = 70, by = 5 )) +
  ylab("VEI") +
  xlab("number of eruptions")
```

```{r eruptions-1812-nsum}
# numerical summary
eruptions_1812_nsum <- eruptions_1812 %>% 
  ungroup() %>% 
  group_by(vei) %>% 
  count() 

eruptions_1812_nsum <- eruptions_1812_nsum %>% 
  ungroup() %>% 
  filter(!is.na(vei)) %>% 
  mutate(total = sum(n),
         cumsum = cumsum(n)) %>% 
  mutate(percent = round(100*cumsum/total,2)) %>% 
  mutate(percent_change = round(percent - lag(percent),2)) %>% 
  select(vei, percent, percent_change) 

# concatenate < VEI
eruptions_1812_nsum$vei <- str_c("< VEI-", eruptions_1812_nsum$vei )

eruptions_1812_nsum <- eruptions_1812_nsum
```

```{r plot-nsum, fig.cap = "Probability density function of eruptions in each VEI category", fig.width = 13}
# change table to tableGrob
t1 <- tableGrob(eruptions_1812_nsum, theme=ttheme_minimal(), rows=NULL)

grid.arrange(eruptions_1812_pdf, t1, ncol = 2,
             widths = c(80,20),
             padding = 2)


```

Theoretically, VEI ranges from 0 to infinity. In this dataset VEI has been recorded on a log10 scale, thereby each interval (increase of 1 in VEI) indicates an eruption 10x the magnitude. There only bee 40 eruptions over the last 132 million years that recorded a VEI-8 magnitude eruption and only in the last 10,000 years, only 10 eruptions have recorded a VEI-7.

Figure \@ref(fig:plot-nsum) presents the number of eruptions for the recorded VEI eruptions since 1812, with the number of eruptions on the x axis and the VEI rating on the y axis. The figure shows:

  - VEI 7 has only one observation since 1812, which occured on Mount Tambora
  - The likelihood of a volcano with VEI 4 or above is very unlikely (less than 1). In fact, almost 98% of all volcanoes have less than VEI-3. 
  - Eruptions with a rating of VEI-2 occur relatively more frequently with quite a number of them occurring > 50 times over the time span.

### How Frequently do volcanoes erupt?

```{r}
volcano_frequent0 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 0) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency)

volcano_frequent0$lag_year <- as.integer(volcano_frequent0$lag_year)

volcano_frequent0$volcano <- as.factor(str_c(volcano_frequent0$volcano_name, "-", volcano_frequent0$vei))

volcano_frequent1 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 1) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 

volcano_frequent1$lag_year <- as.integer(volcano_frequent1$lag_year)

volcano_frequent1$volcano <- as.factor(str_c(volcano_frequent1$volcano_name, "-", volcano_frequent1$vei))

volcano_frequent2 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 2) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 

volcano_frequent2$lag_year <- as.integer(volcano_frequent2$lag_year)

volcano_frequent2$volcano <- as.factor(str_c(volcano_frequent2$volcano_name, "-", volcano_frequent2$vei))

volcano_frequent3 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 3) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 

volcano_frequent3$lag_year <- as.integer(volcano_frequent3$lag_year)

volcano_frequent3$volcano <- as.factor(str_c(volcano_frequent3$volcano_name, "-", volcano_frequent3$vei))

volcano_frequent4 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 4) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 

volcano_frequent4$lag_year <- as.integer(volcano_frequent4$lag_year)

volcano_frequent4$volcano <- as.factor(str_c(volcano_frequent4$volcano_name, "-", volcano_frequent4$vei))
  
volcano_frequent5 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 5) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency)   

volcano_frequent5$lag_year <- as.integer(volcano_frequent5$lag_year)

volcano_frequent5$volcano <- as.factor(str_c(volcano_frequent5$volcano_name, "-", volcano_frequent5$vei))

volcano_frequent6 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 6) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) %>% 
  head(1)


volcano_frequent6$lag_year <- as.integer(volcano_frequent6$lag_year)

volcano_frequent6$volcano <- as.factor(str_c(volcano_frequent6$volcano_name, "-", volcano_frequent6$vei))

volcano_frequent7 <- eruptions_1812 %>% 
  filter(!is.na(vei)) %>% 
  filter(vei == 7) %>% 
  ungroup() %>% 
  group_by(volcano_name, vei) %>%
  mutate(frequency = n()) %>% 
  group_by(vei) %>% 
  arrange(vei,-frequency) %>% 
  top_n(1, frequency) 
  
volcano_frequent7$lag_year <- as.integer(volcano_frequent7$lag_year)

volcano_frequent7$volcano <- as.factor(str_c(volcano_frequent7$volcano_name, "-", volcano_frequent7$vei))

volcano_frequent_total <- tibble(rbind(volcano_frequent0, volcano_frequent1, volcano_frequent2, volcano_frequent3, volcano_frequent4, volcano_frequent5,
      volcano_frequent6, volcano_frequent7))

frequency_plot <- volcano_frequent_total %>% 
  ggplot() +
  geom_tile(aes(x = lag_year,
                y = volcano),
            fill = "red",
            colour = "black") +
  xlab("Year")+
  ylab("Volcano and VEI rating") +
  theme(plot.title = element_text(face = "bold",
                                  size = 15)) +
  scale_x_continuous(breaks = seq(1800, 2020, 25)) 

t2 <- volcano_frequent_total %>% 
  distinct(volcano, .keep_all = TRUE) %>% 
  select(volcano, frequency) 

t2$volcano <- factor(t2$volcano, levels = c("Kilauea-0", "Tambora-7","Krakatau-6","Agung-5", "Kelut-4",  "Bezymianny-3", "Asosan-2", "Etna-1"))





```


```{r tile-plot, fig.cap = "Frequency of Most Active Volcanoes in each VEI category", fig.width = 13, results='asis'}
t2<- tableGrob(t2, theme=ttheme_minimal(), rows=NULL)

grid.arrange(frequency_plot, t2, ncol = 2,
             widths = c(80,20),
             padding = 2)


```

Figure \@ref(fig:tile-plot) displays the volcanoes with the largest count of eruptions for each VEI rating presented in Figure \@ref(fig:plot-nsum). The frequency of eruptions are shown by the red tiles, with each tile representing an eruption, the year along the x axis with the name of the volcano and the corresponding VEI rating on the y axis.

  - Eruptions with VEI 2 occurred the most frequently, followed by volcanoes with VEI-3. 
  - For VEI-4 and above, volcanoes rarely erupted (or erupted prior to 1812) - Kelul-4 was actually an exceptional case as the other VEI-4 volcanoes occurred very seldom. 
  - The gentler eruption events occur more frequently while more explosive eruptions are much less frequent. 


```{r, include=FALSE, echo=FALSE}
vei_du <- eruptions %>%
  na.exclude(vei, start_year, start_month, start_day, end_year, end_month, end_day) %>%
  select(everything()) %>%
  mutate(start = make_date(start_year, start_month, start_day)) %>%
  mutate(end = make_date(end_year, end_month, end_day)) %>%
  mutate(duration = as.numeric(end - start)) %>%
  na.exclude(duration) %>%
  arrange(vei)

vei_du %>%
  group_by(vei) %>%
  summarise(mean(duration))

a1 <- tapply(vei_du$duration, vei_du$vei, summary)
a5num1 <- list2DF(a1) %>%
  mutate(`VEI` = print(c("Min", "Q1", "Median", "Mean", "Q3", "Max"))) 
```


### How is VEI level related to eruption duration? 
!!!removed table!!
```{r jta1, eavl = FALSE}
a5num1k <- kable(a5num1, caption = "Five number summary and mean of duration for each VEI") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
a5num1k

```






```{r jfa1, warning=TRUE, echo=FALSE, fig.cap = "Five number summary distribtuion for VEI level from 0 to 6", fig.height=8, fig.width=14}
abox <- ggplot(vei_du, aes(x = as.factor(vei), y = duration, color = "#FED8B1")) +
  geom_boxplot(outlier.shape = NA) +
  coord_flip() +
  scale_y_continuous(limits=c(-20,500), breaks=seq(0,1500,50), expand = c(0, 0)) +
  labs(x = "VEI",
       y = "Eruption duration (Days)") +
  theme(legend.position = "none")

abox +
  theme(plot.title = element_text(size = 14,
                                  face = "bold"))
```

Figure \@ref(fig:jfa1) visualises the distribtuon of eruption day length for each VEI rating category, with eruption duration, in days, on the x axis and the VEI rating on y-axis. The outliers have been removed for more interpretable results. It is evident with the ommission of outliers that:

  - For all VEI ratings the eruptions lasted less then 500 days with the outliers excluded.
  - Rating 6 VEI has the longest median duration relative to the other ratings.
  - VEI rating of 1 has the shortest median duration.
  - VEI rating 4 has the largest range of duration out of all the eruptions across each VEI rating
  - VEI rating 6 has a maximum duration of 154 days which is lower then the maximum durations of VEI rating 1, 2, 3 and 4. 


```{r, include=FALSE, echo=FALSE}
# keep, but trim outliers
a2 <- vei_du %>%
  select(duration, vei) %>%
  lm(duration ~ ., data = .)
```



```{r glm}
alm <- ggplot(vei_du, aes(x = vei, y = duration)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Linear model of VEI against eruption duration")
aglm <- glance(a2) %>%
  select(r.squared, adj.r.squared)

kable(aglm, caption = "Goodness of fit measure for VEI and duration") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Table \@ref(tab:glm) displays the results for the goodness of fit analysis conducted in order examine the relationship between VEI and duration. 

  - r-square and adjusted r-squared are low with 1.63% and 1.57%. 
    - This implies that only 1.63% of the variation in duration can be explained by a VEI level, if a regression model is fitted, thus concluding the insignificant role of VEI in determining duration.

### Which tectonic settings have longer or shorter eruption duration?

The following section will be analysis the duration of eruptions for the range of tectonic settings.
```{r duration, include=FALSE, message=FALSE, warning=FALSE, echo=FALSE}
a3 <- vei_du %>%
  filter(duration > 365) %>%
  count(volcano_number, volcano_name, latitude, longitude, vei) %>%
  distinct(volcano_number, volcano_name, latitude, longitude, n, vei) %>%
  arrange(desc(n)) %>%
  mutate(`Duration category` = print("Long")) %>%
  mutate(`Avg VEI` = mean(vei))

ajoin3 <- a3 %>%
  select(volcano_number, volcano_number, vei, `Avg VEI`, `Duration category`) %>%
  left_join(volcano) 

  atect3 <- ajoin3 %>%
    select(volcano_number, volcano_name, vei, tectonic_settings) %>%
    count(tectonic_settings) %>%
    mutate(Percentage = n/sum(n)*100)
```





```{r jfa2, include=FALSE, echo=FALSE}  
altectplot <- atect3 %>% 
  filter(!is.na(tectonic_settings)) %>%
  ggplot() + 
  geom_col(aes(x = reorder(tectonic_settings, n), y = n), fill = "red") +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 150, 10)) +
  labs(x = "Tectonic settings",
       y = "Count of eruptions",
       title = "Tectonic settings with long duration ( >365 days) eruptions") +
  theme(plot.title = element_text(size = 14,
                                  face = "bold"),
        axis.text.y.left = element_text(size = 20))
```

```{r, include=FALSE, echo=FALSE}
a4 <- vei_du %>%
  filter(duration < 30) %>%
  count(volcano_number, volcano_name, latitude, longitude, vei) %>%
  distinct(volcano_number, volcano_name, latitude, longitude, n, vei) %>%
  arrange(desc(n)) %>%
  mutate(`Duration category` = print("Short")) %>%
  mutate(`Avg VEI` = mean(vei))

ajoin4 <- a4 %>%
  select(volcano_number, volcano_number, vei, `Avg VEI`, `Duration category`) %>%
  left_join(volcano) 

atect4 <- ajoin4 %>%
  select(volcano_number, volcano_name, vei, tectonic_settings) %>%
  count(tectonic_settings) %>%
  mutate(Percentage = n/sum(n)*100)
```

```{r jfa3, include=FALSE, echo=FALSE}
# keep
astectplot <- atect4 %>% 
  filter(!is.na(tectonic_settings)) %>%
  ggplot() + 
  geom_col(aes(x = reorder(tectonic_settings, n), y = n), fill = "yellow") +
  coord_flip() +
  scale_y_continuous(breaks = seq(0, 150, 10)) +
   labs(x = "Tectonic settings",
       y = "Count of eruptions",
       title = "Tectonic settings with short duration ( <30 days) eruptions") +
  theme(plot.title = element_text(size = 14,
                                  face = "bold"),
        axis.text.y.left = element_text(size = 20))
```

```{r jcbplot, echo=FALSE, fig.align="center", fig.width=14, fig.height = 10, fig.cap = "Eruption duration across the range of tectonic settings"}
grid.arrange(altectplot, astectplot)
```

Figure \@ref(fig:jcbplot) displays two figures, one for tectonic settings with long durations - greater then 365 days, and another for short durations - less then 30 days, with the count of the number of eruptions across the range of tectonic plates along the x axis and the tectonic setting on the y axis. 

For long eruption durations:

  - Subduction zone / Continental crust ( >25km) has the most erupations with the longest duration, making up 58.82% of the erupations that lasted longer then 365 days. It stands far out in front of the next closest tectonic setting which is Subduction zone / Oceanic crust ( <15km) with 14 recorded long eruptions. 
  - The remaining tectonic settings have very close figures, as well as proportions with Intraplate / Intermediate crust (15-25 km) showing to have the least number of long eruptions.
For short eruption durations:
  - Similarly to the long duration, Subduction zone / Continential crust (>25km) has by far the largest number of short duration eruptions and Intraplate / Intermediate crust (15-25km) has the least number of short duration eruptions
  - There is variation in the middle order of tectonic settings relative to the long duration figure with only 7 long duration eruptions (4.575%) on Rift zone / Oceanic crust ( <15km), however the number of short duration eruptions rises to 30, accounting for 10.067% among all tectonic settings. 

Moreover, comparing the count figures, it is apparent that every number from long duration eruptions for all tectonic settings increase when it comes to short duration thus indicating that short duration eruptions occur more frequently than longer ones.


```{r frequency, include=FALSE, echo=FALSE}
bjoin0 <- b0 %>%
  select(volcano_number, volcano_number, vei, `Total eruption`) %>%
  left_join(volcano) 

btect0 <- bjoin0 %>%
  select(volcano_number, volcano_name, tectonic_settings) %>%
  group_by(tectonic_settings) %>%
  count(tectonic_settings) %>%
  ungroup() %>%
  mutate(Percentage = n/sum(n)*100)
```


### What are the eruption frequencies associated with the range of tectonic settings? 

The following section will be analysing which how frequently each tectonic setting erupts, specifically assessing high frequency counts that involve two or more eruptions per year,

```{r jfb1, echo=FALSE, fig.height=8, fig.width=12, fig.cap = "The high or low frequncies associated with the range of tectonic settings"}
# keep
bhftectplot <- btect0 %>% 
  filter(!is.na(tectonic_settings)) %>%
  ggplot() + 
  geom_col(aes(x = reorder(tectonic_settings, n), y = n), fill = "blue") +
  coord_flip() +
  labs(x = "Tectonic settings",
       y = "Count",
       title = "Tectonic settings with high frequency 
       ( 2 eruptions in 1 year) eruptions") +
  theme(plot.title = element_text(face = "bold",
                                  size = 14),
        axis.text.y.left = element_text(size = 15))

bhftectplot
```

```{r, include=FALSE, echo=FALSE}
# keep
hl_tect <- eruptions %>%
  na.exclude(vei) %>%
  left_join(volcano) %>%
  na.exclude(tectonic_settings) %>%
  select(tectonic_settings, vei) %>%
  group_by(tectonic_settings) %>%
  summarise(`Avg vei` = round(mean(vei), digits = 3)) %>%
  arrange(desc(`Avg vei`)) 
```

Figure \@ref(fig:jfb1) displays the tectonic settings with the record of at least two or more volcano eruptions within one year with the count along the x axis and the tectonic setting on the y axis. 
Out of 10 tectonic settings recorded (NAs excluded), only 6 of them are listed under this condition. Tectonic settings with both long and short duration eruptions have all been listed here in regards with high frequency. 

  - Subduction zone / Continental crust ( >25km) is again positioned with the most number (21 times) of eruptions of high frequency however, here it's followed by Intraplate / Oceanic crust ( <15km), where only 7 high and 15 short duration eruptions are marked. 
  - Rift zone / Oceanic crust ( <15km) has the least number of eruptions with high frequency.

### Discussion on tectonic settings and average VEI

Grouped by 10 tectonic settings (NAs excluded), volcano eruptions on Rift zone / Intermediate crust (15-25 km) have the highest average VEI of 2.667, whereas those located on Intraplate / Oceanic crust ( <15 km) obtain the lowest average VEI of 0.923. Furthermore, as shown by Figure \@ref(fig:jcbplot), despite Subduction zone / Continental crust ( >25km) having most longer ( >365 days)  and shorter duration ( <30 days) eruptions occur  as well as having the most higher frequency (  2 eruptions within 1 year) of eruptions, it does not incur a high average VEI. It instead lies in the middle range among the 10 tectonic settings, with the average VEI of 1.982.

Overall, with the highest VEI average (2.667), neither long duration eruptions ( >365 days), nor high frequency ( 2 eruptions in 1 year) eruptions are found in Rift zone / Intermediate crust (15-25 km), while only one eruption of short duration ( <30 days) occurs in this setting.
On the opposite, with the lowest ranking for average VEI (0.923), volcanoes on the Intraplate / Oceanic crust ( <15 km) don't tend to erupt with long duration ( >365 days) where its long duration eruption only holds 4.575%, compared with other tectonic settings. Nevertheless, it has a greater percentage for both short duration (5.033%) and high frequency (9.677%) eruptions.



```{r jtt1, echo=FALSE}
tect_avg <- kable(hl_tect, caption = "Average VEI level for each tectonic setting") %>% kable_styling(bootstrap_options = c("striped", "hover"))

tect_avg
```

# Assignment 2 Extra questions

## Is there any relationship between tree rings and volcanic eruption events? (Edited by Yuheng Cui)

Tree ring is an important indicator to reveal climate and temperature change. `tree_rings` dataset contains the values of two variables (`n_tree` and `europe_temp_index`) from year 0 to year 2000. `n_tree` is tree ring z-scores relative to year and z-score is a measure of variability from the mean). `europe_temp_index` is the average yearly temperature for Europe in Celsius relative to 1961 to 1990. We know that tree ring width reflects the growth conditions of the tree --- the condition refers to nutrient conditions, precipitation and temperature during a growing season. @seiler2017tree suggest "the ring width may also be influenced by volcanic activity on Mount Etna and in other volcanic regions. @seiler2017tree also suggest the pre-eruptive phase can only have begun when the trees had already ceased their seasonal growth.

### Limitation of `tree_ring` dataset

`tree_ring` dataset does not have the accurate tree ring z-score value near the volcanoes, and the temperature index is related to only Europe but not near the active volcanoes. The second limitation is because wildfires also affect the tree ring z-score, but we don't have the wildfires records of Europe. 

Due to `tree_ring` dataset only containing the temperature index and tree ring data in Europe, we filter the eruption events that occur in Europe only. However, most eruption events were in Russia, and partial Russian territory is belong to Europe. In other words, not all eruptions affect Europe temperature index. But it is still worthy to analyse the relationship between tree rings and volcanic eruption events by using the `tree_ring` dataset.


### Analysis

First, we draw a plot for `n_tree` and `europe_temp_index`. Fig \@ref(fig:tree-ring) shows these the changes of two variables along time. The vertical dash lines indicate the eruption events. It seems that two lines generally fit each other. To ensure the correlation between these two variables, we run a correlation test. Table \@ref(tab:cortest) shows the estimated correlation is 0.79 and p-value is less than 0.05. This is to say that we are 95% confident that two variables are strongly correlated. Thus, we can build a model for these two variables.


```{r eruptions-in-euro}
euro_list <- read_html("https://en.wikipedia.org/wiki/List_of_European_countries_by_area") %>% 
  html_table(fill = TRUE)

euro_list <- euro_list[[1]] %>% 
  select(State) %>% 
  mutate(State = stringr::str_remove(State, "\\*"))

euro_list_clean <- euro_list %>% 
  left_join(volcano_erupted, by = c("State" = "country")) %>% 
  select(State, start_year, end_year) %>% 
  filter(start_year %in% c(1:2000))

```

```{r tree-ring, out.width = '150%', fig.cap = "Tree ring z-score and temperature index"}
tree_ring_clean <- tree_rings %>% 
  filter(!is.na(year))

tree_ring_clean %>% 
  pivot_longer(cols = c("n_tree", "europe_temp_index"), names_to = "type", values_to = "value") %>% 
  ggplot(aes(x = year, y = value, color = type)) +
  geom_line(alpha = 0.5)+
  geom_vline(xintercept = euro_list_clean[,2], linetype = "dashed") +
  theme(legend.title = element_blank(),
        legend.position = "bottom")


```

```{r cortest}
cor.test(tree_ring_clean$n_tree, tree_ring_clean$europe_temp_index) %>% tidy() %>% kable(caption = "Correlation test for tree ring z-score and temperature index") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))
```

We build two linear models: 
$$\large{lm\_1} :\large{\widehat{\text{Europe temp index}}} = 0.1073 + 0.4941 * \text{Tree ring z-score}$$

$$\large{lm\_2} :\large{\widehat{\text{Europe temp index}}} = 0.10765 + 0.49421 * \text{Tree ring z-score} - 0.02598 * \text{Eruption}$$
In `lm_2`, for `eruption`, 1 means there was an eruption while 0 means none.

Table \@ref(tab:lmtreering) shows the goodness of two models. `lm_2` is slightly better than `lm_1` because its $r^2$ is slightly greater than `lm_1`'s $r^2$. In conclusion, both of them are not good because of low `r_square`. For example, `lm_1` has $r^2$ of 0.6287, which means only 62.87% of variation explained by the model. The reason might be an eruption has its radius of influence, and most of the eruptions were in Russia, thus, they did not have big influence in Europe temperature index. In addition, even there was a big eruption, it can hardly affect the whole Europe or the yearly average temperature index.  

To visulising the fittness of `lm_2`, we plot the residual value based on `lm_2`. Residual value refers to the difference between observed and predicted value. If a model is a good model, the residual value would close to y intercept. Fig \@ref(fig:lm_2_resid) shows the residual value spread, and variation of residual value is increasing while the temperature index is more far away from 0. This means, in some degree, `lm_2` can predict the `europe_temp_index` under non-extreme value of `n_tree`.

```{r lmtreering}
# insert the eruption variable into the tree ring dataset
tree_ring_clean <- tree_ring_clean %>% 
  # eruption = 1 means there was an eruption, eruption = 0 means none eruption.
  mutate(eruption = case_when(
    year %in% euro_list_clean[,2] ~ 1,
    TRUE ~ 0
  ),
  eruption = as.factor(eruption))

tree_lm_1 <- lm(europe_temp_index ~ n_tree, data = tree_ring_clean)
tree_lm_2 <- lm(europe_temp_index ~ n_tree +eruption, data = tree_ring_clean)

tibble(model = c("lm_1 (no eruption)", "lm_2 (eruption)"), r_square = c(glance(tree_lm_1)[[2]],
glance(tree_lm_2)[[2]])) %>% kable(caption = "Compare two models") %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center")
```




```{r lm_2_resid, fig.cap = "Residual lm_2"}  
augment(tree_lm_2) %>% 
  ggplot(aes(x = europe_temp_index, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = 'red') +
  geom_smooth(method = "glm")
```


# Acknowledgements

Data source is from @smithsonian.

In order to map the tectonic boundaries the tectonic plates were split at the prime meridian (x-intercept where long = 0) with the assistiance of Z.Lin at [StackOverflow](https://stackoverflow.com/questions/63591697/how-to-split-tectonic-plate-boundary-polygon-in-a-way-to-prevent-line-across-the/63593236?noredirect=1#comment112479435_63593236). The datasets were joined with the world map datasets provided by `ggplot` to find the continent and country coordinates as well as dataset from [Kaggle](https://www.kaggle.com/cwthompson/tectonic-plate-boundaries) to obtain coordinates to plot the tectonic plates polygon.

These packages are used to produce this report:

tidyverse [@tidyverse], lubridate [@lubridate], broom [@broom], leaflet [@leaflet], ggmap [@ggmap], mapview[@mapview], viridis [@viridis], rgdal [@rgdal], kableExtra [@kableExtra], gridExtra [@gridExtra], readr [@readr], knitr [@knitr], sf [@sf], data.table [@data], ggthemes [@ggthemes], maps [@maps], ggridges [@ggridges], rvest [@rvest]


# References



  

  




