---
title: "ETC5521 Assignment 1"
subtitle: "Your title"
team: [FILL]
author:
  - [FILL]
  - [FILL]
date: "`r Sys.Date()`"
output: 
  html_document
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

```{r, eval = FALSE}
# ----- cleaning script 
library(readxl)
library(tidyverse)
library(lubridate)
library(broom)
library(leaflet)
library(ggmap)
library(mapview)
library(viridis)
library(rgdal)
library(kableExtra)

eruption_list <- read_csv("2020/2020-05-12/eruption_list.csv", skip = 1) %>% 
  janitor::clean_names() %>% 
  select(-contains("modifier"), -contains("uncertainty"))

event_list <- read_csv("2020/2020-05-12/event_list.csv", skip = 1) %>% 
  janitor::clean_names() %>% 
  select(-contains("modifier"), -contains("uncertainty"))

volcano_list <- read_csv("2020/2020-05-12/volcano_list.csv", skip = 1) %>% 
  janitor::clean_names()

eruption_list %>% 
  write_csv("2020/2020-05-12/eruptions.csv")

event_list %>% 
  write_csv("2020/2020-05-12/events.csv")

volcano_list %>% 
  write_csv("2020/2020-05-12/volcano.csv")
```

```{r getting-data}
# Get the Data

volcano <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/volcano.csv')
eruptions <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/eruptions.csv')
events <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/events.csv')
tree_rings <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/tree_rings.csv')
sulfur <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-05-12/sulfur.csv')

# --- Or read in with tidytuesdayR package (https://github.com/thebioengineer/tidytuesdayR)
# PLEASE NOTE TO USE 2020 DATA YOU NEED TO USE tidytuesdayR version ? from GitHub

# Either ISO-8601 date or year/week works!

# Install via devtools::install_github("thebioengineer/tidytuesdayR")

# tuesdata <- tidytuesdayR::tt_load('2020-05-12')
# tuesdata <- tidytuesdayR::tt_load(2020, week = 20)

# volcano <- tuesdata$volcano
```

# Introduction and motivation

[FILL] Give the bigger picture of the data, and inspire the reader to learn more about the problem by reading your analysis. 

# Data description
The data source is from The Smithsonian Institution (volcano.si.edu), which has been constantly updating since 2013. The data was made available for download on (https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-05-12/readme.md), so that we directly import the 5 data sets for this analysis. These 5 data sets are volcano, eruptions, events, tree_rings and sulfur, allowing us to discover the influences among them. 

- `volcano` data set consists of 26 variables, encompassing the location, geological and population information of the 958 volcanoes recorded. For variables "last_eruption_year", "major_rock" and "minor_rock", some cells are labelled as "unknown" or leave as blank for cases where data is unknown or unrecorded. 

- `eruptions` data set comprises of 15 variables, which mainly notes down the exact occurrence of each eruption since Holecene. Further, the severity of eruptions is represented by variable, "vei (Volcano Explosivity Index)" in ascending order, taking values from 0 to 7. Unknown data appears commonly among variables "area_of_activity", "start_month", "start_day", "end_year", "end_month" and "end_day", denoted with "NA".

- `events` data set contains 10 variables, recording the occurrence details of 41322 events of volcanoes. Despite variables such as "event_type" and "event_remark" , a lot of its variables (e.g. eruption dates) overlap with that of `eruptions`, thus it seems as a condensed version of `eruptions`. "NA" are presented regularly for "event_remarks" and mostly event dates information.

- `tree_rings` data set includes 3 variables which acts as an effective measurement for temperature, meanwhile enabling researchers to confirm climate change as an impact of volcanoes eruptions. The measurements are conducted yearly and no data is missing.

- `sulfur` data set also contains 3 variables, recording the amount of sulfur detected as an effect due to volcanoes eruptions. Using the same unit for measurement, the data for "neem" is collected from Greenland while it is from Anatartica for "wdc".
# Analysis and findings

[FILL] Should include at least one plot or numerical summary for each of your questions, that helps the reader arrive at an answer. You should also write paragraphs describing the methods, summaries and findings. 

```{r}
vei_du <- eruptions %>%
  na.exclude(vei, start_year, start_month, start_day, end_year, end_month, end_day) %>%
  select(everything()) %>%
  mutate(start = make_date(start_year, start_month, start_day)) %>%
  mutate(end = make_date(end_year, end_month, end_day)) %>%
  mutate(duration = as.numeric(end - start)) %>%
  na.exclude(duration) %>%
  arrange(vei)

vei_du %>%
  group_by(vei) %>%
  summarise(mean(duration))
# keep
a1 <- tapply(vei_du$duration, vei_du$vei, summary)
a5num1 <- list2DF(a1) %>%
  mutate(`VEI` = print(c("Min", "Q1", "Median", "Mean", "Q3", "Max"))) 
```

```{r}
a5num1k <- kable(a5num1, caption = "Five number summary and mean of duration for each VEI")
```
# keep
```{r}
abox <- ggplot(vei_du, aes(x = as.factor(vei), y = duration, color = vei)) +
  geom_boxplot(outlier.shape = NA) +
  coord_flip() +
  scale_y_continuous(limits=c(-100,2000), breaks=seq(0,2000,500), expand = c(0, 0)) +
  labs(title = "Five number summary distribtuion for VEI level from 0 to 6",
       x = "VEI",
       y = "Eruption duration (Days)")
```

```{r}
# keep, but trim outliers
a2 <- vei_du %>%
  select(duration, vei) %>%
  lm(duration ~ ., data = .)
```

```{r}
alm <- ggplot(vei_du, aes(x = vei, y = duration)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Linear model of VEI against eruption duration")
glance(a2) 
```
FIGURE summarises the distribution of eruption duration measured in days for each VEI level from 0 to 6.
```{r duration}
a3 <- vei_du %>%
  filter(duration > 365) %>%
  count(volcano_number, volcano_name, latitude, longitude, vei) %>%
  distinct(volcano_number, volcano_name, latitude, longitude, n, vei) %>%
  arrange(desc(n)) %>%
  mutate(`Duration category` = print("Long")) %>%
  mutate(`Avg VEI` = mean(vei))

ajoin3 <- a3 %>%
  select(volcano_number, volcano_number, vei, `Avg VEI`, `Duration category`) %>%
  left_join(volcano) 

  atect3 <- ajoin3 %>%
    select(volcano_number, volcano_name, vei, tectonic_settings) %>%
    count(tectonic_settings) %>%
    mutate(Percentage = n/sum(n)*100)
```

```{r}  
# keep
altectplot <- atect3 %>% 
  filter(!is.na(tectonic_settings)) %>%
  ggplot() + 
  geom_col(aes(x = reorder(tectonic_settings, n), y = n), fill = "red") +
  coord_flip() +
  labs(x = "Tectonic settings",
       y = "Count",
       title = "Tectonic settings with high duration ( >365 days) eruptions")
```
```{r}
a4 <- vei_du %>%
  filter(duration < 30) %>%
  count(volcano_number, volcano_name, latitude, longitude, vei) %>%
  distinct(volcano_number, volcano_name, latitude, longitude, n, vei) %>%
  arrange(desc(n)) %>%
  mutate(`Duration category` = print("Short")) %>%
  mutate(`Avg VEI` = mean(vei))

ajoin4 <- a4 %>%
  select(volcano_number, volcano_number, vei, `Avg VEI`, `Duration category`) %>%
  left_join(volcano) 

atect4 <- ajoin4 %>%
  select(volcano_number, volcano_name, vei, tectonic_settings) %>%
  count(tectonic_settings) %>%
  mutate(Percentage = n/sum(n)*100)
```

```{r}
# keep
astectplot <- atect4 %>% 
  filter(!is.na(tectonic_settings)) %>%
  ggplot() + 
  geom_col(aes(x = reorder(tectonic_settings, n), y = n), fill = "yellow") +
  coord_flip() +
   labs(x = "Tectonic settings",
       y = "Count",
       title = "Tectonic settings with short duration ( ≤30 days) eruptions")
```

```{r}
# keep
a5 <- rbind(a3, a4)
make_bbox(lon = a5$longitude, 
                a5$latitude, f = 0.9) 

pal <- colorFactor(
  palette = c('red', 'yellow'),
  domain = a5$`Duration category`
)

a5_locations = leaflet(data = a5) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%
  addCircles(
    lng = a5$longitude, 
    lat = a5$latitude, 
    group = a5$`Duration category`,
    radius = 10,
    fill=TRUE, color= ~pal(`Duration category`),
    weight= 10,
    stroke = FALSE, fillOpacity = 0.8,
    label = a5$volcano_name) %>%
   addTiles() %>%
   addLegend(pal = pal, values = ~`Duration category`, opacity = 1, 
            title = "Duration category", position = "bottomright") %>%   addProviderTiles("CartoDB.Positron")
a5_locations
```

```{r frequency}
b0 <- eruptions %>%
  na.exclude(vei, start_year) %>%
  group_by(start_year) %>%
  select(volcano_number, volcano_name, vei, latitude, longitude, start_year) %>%
  count(volcano_number, volcano_name, vei, latitude, longitude) %>%
  arrange(desc(n)) %>%
  mutate(`Total eruption` = sum(b0$n)) 

bjoin0 <- b0 %>%
  select(volcano_number, volcano_number, vei, `Total eruption`) %>%
  left_join(volcano) 
```

```{r}
 pal1 <- colorFactor(
  palette = c('yellow', 'orange', 'red', 'dark red'),
  domain = b0$vei
)
# categorised by VEI
b0_locations = leaflet(data = b0) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%
  addCircles(
    lng = b0$longitude, 
    lat = b0$latitude, 
    group = b0$`Duration category`,
    radius = 10,
    fill=TRUE, color= ~pal1(vei),
    weight= 10,
    stroke = FALSE, fillOpacity = 0.8,
    label = b0$volcano_name) %>%
   addTiles() %>%
   addLegend(pal = pal1, values = ~vei, opacity = 1, 
            title = "VEI level", position = "bottomright") %>%   addProviderTiles("CartoDB.Positron")
b0_locations 
```

```{r}
# erupt twice or more within a year
bjoin0 <- b0 %>%
  ungroup(vei, start_year) %>%
  filter(n >= 2) %>%
  distinct(volcano_number, volcano_name) %>%
  left_join(volcano)

btect0 <- bjoin0 %>%
  select(volcano_number, volcano_name, tectonic_settings) %>%
  group_by(tectonic_settings) %>%
  count(tectonic_settings) %>%
  ungroup() %>%
  mutate(Percentage = n/sum(n)*100)

bmean0 <- b0 %>%
  ungroup(vei, start_year) %>%
  filter(n >= 2) %>%
  summarise(mean(vei))
```

```{r}
# keep
bhftectplot <- btect0 %>% 
  filter(!is.na(tectonic_settings)) %>%
  ggplot() + 
  geom_col(aes(x = reorder(tectonic_settings, n), y = n)) +
  coord_flip() +
  labs(x = "Tectonic settings",
       y = "Count",
       title = "Tectonic settings with high frequency ( ≥2 eruptions in 1 year) eruptions")
```

```{r}
# keep
hl_tect <- eruptions %>%
  na.exclude(vei) %>%
  left_join(volcano) %>%
  na.exclude(tectonic_settings) %>%
  select(tectonic_settings, vei) %>%
  group_by(tectonic_settings) %>%
  summarise(`Avg vei` = round(mean(vei), digits = 3)) %>%
  arrange(desc(`Avg vei`)) 
```

```{r}
tect_avg <- kable(hl_tect, caption = "Average VEI level for each tectonic setting")
tect_avg
```


# References
